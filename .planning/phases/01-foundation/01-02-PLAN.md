---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - vitest.config.ts
  - tests/setup.ts
  - tests/unit/sample.test.ts
  - docker-compose.yml
  - .vscode/launch.json
autonomous: true

must_haves:
  truths:
    - "pnpm test runs Vitest and reports results"
    - "pnpm test:coverage generates coverage report"
    - "docker-compose up starts IPFS and Redis containers"
    - "VS Code can attach debugger to running server"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration"
      contains: "coverage"
    - path: "tests/setup.ts"
      provides: "Test setup file"
      min_lines: 5
    - path: "docker-compose.yml"
      provides: "Development dependency containers"
      contains: "ipfs"
    - path: ".vscode/launch.json"
      provides: "Debug configuration"
      contains: "attach"
  key_links:
    - from: "vitest.config.ts"
      to: "tests/setup.ts"
      via: "setupFiles reference"
      pattern: "setup\\.ts"
    - from: "package.json"
      to: "vitest.config.ts"
      via: "test script"
      pattern: "vitest"
---

<objective>
Setup testing infrastructure with Vitest and development environment with Docker containers.

Purpose: Enable test-driven development and provide external services (IPFS, Redis) that later phases will integrate with. Testing must be available from day one.

Output: Working Vitest configuration with coverage, Docker Compose for IPFS/Redis, VS Code debug configuration.
</objective>

<execution_context>
@/Users/morgan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vitest with coverage reporting</name>
  <files>
    vitest.config.ts
    tests/setup.ts
    tests/unit/sample.test.ts
  </files>
  <action>
    1. Create vitest.config.ts per RESEARCH.md:
       ```typescript
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         test: {
           globals: true,
           environment: 'node',
           include: ['tests/**/*.test.ts'],
           setupFiles: ['./tests/setup.ts'],
           coverage: {
             provider: 'v8',
             reporter: ['text', 'html', 'json'],
             include: ['src/**/*.ts'],
             exclude: ['src/types/**'],
             thresholds: {
               statements: 0,
               branches: 0,
               functions: 0,
               lines: 0,
             },
           },
         },
         resolve: {
           alias: {
             '@': './src',
           },
         },
       });
       ```
       Note: Thresholds at 0 initially, will increase as code is added

    2. Create tests/setup.ts:
       ```typescript
       // Global test setup
       // Add shared test utilities, mocks, or environment setup here

       // Ensure clean test environment
       beforeEach(() => {
         // Reset any global state if needed
       });
       ```

    3. Create tests/unit/sample.test.ts:
       ```typescript
       import { describe, it, expect } from 'vitest';

       describe('Sample test', () => {
         it('should pass a basic assertion', () => {
           expect(1 + 1).toBe(2);
         });

         it('should handle async operations', async () => {
           const result = await Promise.resolve('hello');
           expect(result).toBe('hello');
         });
       });
       ```

    4. Update package.json scripts:
       - "test": "vitest run"
       - "test:watch": "vitest"
       - "test:coverage": "vitest run --coverage"

    5. Add coverage/ to .gitignore
  </action>
  <verify>
    - `pnpm test` runs and shows 2 passing tests
    - `pnpm test:coverage` generates coverage report
    - coverage/ directory created with HTML report
  </verify>
  <done>
    Vitest runs tests with coverage reporting. Sample tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Setup Docker Compose for dependencies</name>
  <files>
    docker-compose.yml
    .gitignore
  </files>
  <action>
    1. Create docker-compose.yml per RESEARCH.md:
       ```yaml
       # Development dependencies - IPFS and Redis
       # App runs locally with hot reload, containers provide services
       version: '3.8'

       services:
         ipfs:
           image: ipfs/kubo:latest
           container_name: x402-ipfs
           ports:
             - "4001:4001"      # P2P swarm
             - "5001:5001"      # HTTP API
             - "8080:8080"      # Gateway
           volumes:
             - ipfs_data:/data/ipfs
           environment:
             - IPFS_PATH=/data/ipfs
           restart: unless-stopped

         redis:
           image: redis:7-alpine
           container_name: x402-redis
           ports:
             - "6379:6379"
           volumes:
             - redis_data:/data
           command: redis-server --appendonly yes
           restart: unless-stopped

       volumes:
         ipfs_data:
         redis_data:
       ```

    2. Add to .gitignore if not present:
       ```
       # Docker volumes (managed by Docker)
       # No additional ignores needed - data is in named volumes
       ```

    3. Add convenience scripts to package.json:
       - "docker:up": "docker-compose up -d"
       - "docker:down": "docker-compose down"
       - "docker:logs": "docker-compose logs -f"
  </action>
  <verify>
    - `pnpm docker:up` starts containers
    - `docker ps` shows x402-ipfs and x402-redis running
    - `curl http://localhost:5001/api/v0/id` returns IPFS node info
    - `docker exec x402-redis redis-cli ping` returns PONG
    - `pnpm docker:down` stops containers
  </verify>
  <done>
    Docker Compose starts IPFS and Redis. Both services accessible on localhost.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add VS Code debug configuration</name>
  <files>
    .vscode/launch.json
    .vscode/settings.json
  </files>
  <action>
    1. Create .vscode/launch.json:
       ```json
       {
         "version": "0.2.0",
         "configurations": [
           {
             "name": "Debug Server",
             "type": "node",
             "request": "launch",
             "runtimeExecutable": "pnpm",
             "runtimeArgs": ["dev"],
             "console": "integratedTerminal",
             "skipFiles": ["<node_internals>/**"],
             "env": {
               "NODE_ENV": "development"
             }
           },
           {
             "name": "Debug Tests",
             "type": "node",
             "request": "launch",
             "runtimeExecutable": "pnpm",
             "runtimeArgs": ["test"],
             "console": "integratedTerminal",
             "skipFiles": ["<node_internals>/**"]
           },
           {
             "name": "Attach to Process",
             "type": "node",
             "request": "attach",
             "port": 9229,
             "skipFiles": ["<node_internals>/**"]
           }
         ]
       }
       ```

    2. Create .vscode/settings.json:
       ```json
       {
         "editor.formatOnSave": true,
         "editor.defaultFormatter": "esbenp.prettier-vscode",
         "editor.codeActionsOnSave": {
           "source.fixAll.eslint": "explicit"
         },
         "typescript.tsdk": "node_modules/typescript/lib",
         "typescript.enablePromptUseWorkspaceTsdk": true
       }
       ```

    3. Update package.json dev script for debugging:
       - "dev": "tsx watch --inspect src/index.ts"
  </action>
  <verify>
    - .vscode/launch.json exists with 3 configurations
    - `pnpm dev` starts with inspector listening message
    - VS Code "Debug Server" configuration launches without error
  </verify>
  <done>
    VS Code debug configurations work. Dev server runs with hot reload and debugging support.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `pnpm test` - runs and passes
2. `pnpm test:coverage` - generates coverage report in coverage/
3. `pnpm docker:up` - starts IPFS and Redis containers
4. `curl http://localhost:5001/api/v0/id` - returns IPFS peer ID
5. `pnpm dev` - starts dev server with --inspect flag
6. VS Code F5 with "Debug Server" selected - attaches debugger
</verification>

<success_criteria>
- Vitest runs tests with coverage reporting
- Sample tests pass demonstrating test infrastructure works
- Docker Compose starts IPFS (Kubo) and Redis containers
- IPFS accessible on ports 4001, 5001, 8080
- Redis accessible on port 6379
- VS Code can debug running server and tests
- Dev server has hot reload via tsx watch
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
