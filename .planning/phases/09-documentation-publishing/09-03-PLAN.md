---
phase: 09-documentation-publishing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/architecture.md
autonomous: true

must_haves:
  truths:
    - "Architecture diagrams explain the system clearly to someone unfamiliar with x402"
    - "Diagrams render natively on GitHub (Mermaid in markdown)"
    - "Four diagrams cover: component relationships, payment flow, internal architecture, data flow"
  artifacts:
    - path: "docs/architecture.md"
      provides: "Four Mermaid diagrams with explanatory text"
      min_lines: 150
      contains: "```mermaid"
  key_links:
    - from: "docs/architecture.md"
      to: "README.md"
      via: "referenced from README documentation section"
      pattern: "architecture"
---

<objective>
Create docs/architecture.md with four Mermaid diagrams: (1) component diagram showing facilitator, SDK, resource server, client relationships, (2) payment flow sequence diagram showing the full x402 cycle, (3) internal architecture diagram showing chain provider, UTXO cache, Redis, Blockfrost, verification pipeline, settlement pipeline, (4) data flow diagram showing how a transaction moves through the system.

Purpose: Visual documentation for developers unfamiliar with x402 or Cardano to understand the system.
Output: docs/architecture.md with four Mermaid diagrams that render on GitHub.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-documentation-publishing/09-RESEARCH.md

@src/server.ts
@src/verify/types.ts
@src/settle/types.ts
@src/sdk/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create architecture.md with four Mermaid diagrams</name>
  <files>docs/architecture.md</files>
  <action>
Create `docs/architecture.md` with the following structure. Each diagram must use Mermaid syntax (renders natively on GitHub). Include brief explanatory text between diagrams.

**Title and intro:**
```markdown
# Architecture

This document describes the x402 Cardano Payment Facilitator's architecture through four diagrams: how components relate, how payments flow, how the facilitator is structured internally, and how transaction data moves through the verification and settlement pipeline.
```

**Diagram 1: Component Diagram (graph TD)**
Show the four actors and their relationships:
- **Client** (wallet, builds/signs transactions)
- **Resource Server** (serves content, uses SDK)
- **Facilitator** (this project -- verifies + settles)
- **Cardano Blockchain** (Blockfrost API)

Relationships:
- Client <-> Resource Server: HTTP requests, 402 responses, Payment-Signature header
- Resource Server -> Facilitator: POST /verify, POST /settle (via SDK FacilitatorClient)
- Facilitator -> Cardano: Submit tx, query UTXOs, get slots (via Blockfrost)
- Client -> Cardano: Build tx using Lucid Evolution

Also show the SDK as a subgraph within the Resource Server:
- `createPaymentGate()` middleware
- `FacilitatorClient` for API calls
- `reply402()` for 402 responses

**Diagram 2: Payment Flow (sequenceDiagram)**
Full x402 payment cycle with 7 steps:
1. Client -> Resource Server: POST /upload (no payment)
2. Resource Server -> Client: 402 Payment Required (Payment-Required header)
3. Client: Parse requirements, build Cardano tx with Lucid, sign
4. Client -> Resource Server: POST /upload + Payment-Signature header
5. Resource Server (payment gate) -> Facilitator: POST /verify
6. Facilitator: Run 10-check verification pipeline
7. Facilitator -> Resource Server: isValid: true
8. Resource Server (payment gate) -> Facilitator: POST /settle
9. Facilitator -> Cardano: Submit CBOR tx via Blockfrost
10. Cardano -> Facilitator: Transaction confirmed
11. Facilitator -> Resource Server: success: true, txHash
12. Resource Server: Execute business logic (store file)
13. Resource Server -> Client: 200 OK + result

**Diagram 3: Internal Architecture (graph TD with subgraphs)**
Show facilitator internals:
- Subgraph "HTTP Layer": Fastify server, routes (/health, /supported, /verify, /settle, /status, /upload, /files/:cid), middleware (helmet, CORS, rate limit)
- Subgraph "Verification Pipeline": CBOR deserializer (CML), 10 check functions in order
- Subgraph "Settlement Pipeline": Re-verify, dedup (SHA-256 + Redis SET NX), Blockfrost submit, poll confirmation
- Subgraph "Chain Layer": ChainProvider, BlockfrostClient (retry + backoff), UTXO cache (L1 Map + L2 Redis), UTXO reservation, Lucid Evolution
- Subgraph "Storage Layer": StorageBackend interface, FsBackend, IpfsBackend
- External: Redis, Blockfrost API

**Diagram 4: Data Flow (flowchart LR)**
Show how a transaction moves through verification + settlement:
```
Base64 CBOR in -> Decode Base64 -> Deserialize CBOR (CML)
  -> Check scheme (exact)
  -> Check network (CAIP-2)
  -> Check token supported (registry)
  -> Check recipient (address hex comparison)
  -> Check amount (>= required, ADA or token)
  -> Check min UTXO (protocol params)
  -> Check witness (signature present)
  -> Check TTL (not expired, within bounds)
  -> Check fee (within bounds)
  -> All pass? -> Settlement
    -> SHA-256 dedup key
    -> Redis SET NX (idempotent)
    -> Blockfrost /tx/submit
    -> Poll getTransaction (5s interval, 120s timeout)
    -> Confirmed / Timeout
```

Each diagram should be concise but complete. Use appropriate Mermaid diagram types:
- Component: `graph TD` with subgraphs
- Payment flow: `sequenceDiagram`
- Internal: `graph TD` with subgraphs
- Data flow: `flowchart LR`

Total file should be ~200-300 lines with diagrams and explanatory text.

Do NOT include implementation details like file paths or function names in the diagrams -- keep them conceptual. The code references belong in the explanatory text between diagrams.
  </action>
  <verify>
  `docs/architecture.md` exists. `grep -c 'mermaid' docs/architecture.md` returns 4 (four mermaid code blocks). File is at least 150 lines. Verify Mermaid syntax is valid by checking for common errors (unclosed blocks, missing arrows).
  </verify>
  <done>docs/architecture.md contains four Mermaid diagrams covering component relationships, payment flow, internal architecture, and data flow.</done>
</task>

</tasks>

<verification>
1. `docs/architecture.md` exists with 4 Mermaid diagrams
2. Each diagram has explanatory text
3. No sensitive information (API keys, addresses) in diagrams
4. Mermaid syntax appears valid (balanced code blocks)
</verification>

<success_criteria>
- Four distinct diagrams render when viewed on GitHub
- Someone unfamiliar with x402 can understand the system's structure from the diagrams
- Component relationships, payment flow, internal architecture, and data flow are all covered
</success_criteria>

<output>
After completion, create `.planning/phases/09-documentation-publishing/09-03-SUMMARY.md`
</output>
