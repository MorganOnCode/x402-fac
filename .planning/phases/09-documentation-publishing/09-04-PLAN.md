---
phase: 09-documentation-publishing
plan: 04
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - tsup.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "npm package has dual entry points: server (.) and SDK (./sdk)"
    - "SDK entry point only bundles SDK code, not server dependencies"
    - "TypeScript types (.d.ts) generated for both entry points"
    - "npm pack --dry-run shows only dist/, LICENSE, README.md"
  artifacts:
    - path: "tsup.config.ts"
      provides: "Dual entry points for server and SDK"
      contains: "sdk"
    - path: "package.json"
      provides: "exports map with . and ./sdk conditions"
      contains: "./sdk"
  key_links:
    - from: "package.json"
      to: "dist/sdk.js"
      via: "exports map ./sdk subpath"
      pattern: "dist/sdk"
    - from: "tsup.config.ts"
      to: "src/sdk/index.ts"
      via: "entry point configuration"
      pattern: "sdk.*index"
---

<objective>
Configure dual tsup entry points (server + SDK) and package.json exports map for npm publishing. Add files whitelist, prepublishOnly script, and verify the SDK bundle doesn't pull in server dependencies.

Purpose: Resource server builders can `import { FacilitatorClient } from 'x402-fac/sdk'` without pulling in Fastify, ioredis, Sentry, etc.
Output: Updated tsup.config.ts and package.json ready for npm publish.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-documentation-publishing/09-RESEARCH.md

@tsup.config.ts
@package.json
@src/sdk/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure dual entry points and npm publishing</name>
  <files>tsup.config.ts, package.json</files>
  <action>
1. **Update tsup.config.ts** for dual entry points:
   ```typescript
   import { defineConfig } from 'tsup';

   export default defineConfig({
     entry: {
       index: './src/index.ts',
       sdk: './src/sdk/index.ts',
     },
     format: ['esm'],
     dts: true,
     clean: true,
     sourcemap: true,
     tsconfig: './tsconfig.build.json',
   });
   ```
   Change from array entry `['./src/index.ts']` to object entry `{ index: '...', sdk: '...' }`.

2. **Update package.json** with the following changes (read package.json first):

   a. Add `exports` map:
   ```json
   "exports": {
     ".": {
       "import": "./dist/index.js",
       "types": "./dist/index.d.ts"
     },
     "./sdk": {
       "import": "./dist/sdk.js",
       "types": "./dist/sdk.d.ts"
     }
   }
   ```

   b. Keep existing `main` and `types` for backward compat:
   ```json
   "main": "dist/index.js",
   "types": "dist/index.d.ts",
   ```

   c. Add `files` whitelist (CRITICAL for security -- prevents publishing secrets):
   ```json
   "files": [
     "dist/",
     "LICENSE",
     "README.md"
   ]
   ```

   d. Add `prepublishOnly` script:
   ```json
   "prepublishOnly": "pnpm build"
   ```

   e. Update `description` to be more descriptive:
   ```json
   "description": "Cardano x402 payment facilitator with resource server SDK"
   ```

   f. Add `repository`, `bugs`, `homepage` fields (use placeholder URL):
   ```json
   "repository": {
     "type": "git",
     "url": "https://github.com/YOUR_USERNAME/x402-fac.git"
   },
   "bugs": {
     "url": "https://github.com/YOUR_USERNAME/x402-fac/issues"
   },
   "homepage": "https://github.com/YOUR_USERNAME/x402-fac#readme"
   ```

3. **Build and verify**:
   - Run `pnpm build` to confirm both entry points compile
   - Verify `dist/index.js`, `dist/index.d.ts`, `dist/sdk.js`, `dist/sdk.d.ts` all exist
   - Run `pnpm pack --dry-run` to verify the files whitelist works (should show only dist/, LICENSE, README.md, package.json)
   - Check that `dist/sdk.js` does NOT contain Fastify, ioredis, or @sentry/node imports (it should only reference zod and the SDK's own types)

4. **Verify tests still pass**: `pnpm test` -- all 383+ tests pass.

IMPORTANT: The `files` field is a security gate. Only `dist/`, `LICENSE`, and `README.md` should be published. This prevents `.planning/`, `config/`, `tests/`, and other sensitive directories from ending up on npm.
  </action>
  <verify>
  `pnpm build` succeeds. `ls dist/sdk.js dist/sdk.d.ts dist/index.js dist/index.d.ts` -- all four files exist. `pnpm pack --dry-run` shows only expected files (dist/, LICENSE, README.md, package.json). `pnpm test` passes.
  </verify>
  <done>Dual entry points configured. SDK importable via 'x402-fac/sdk'. Package ready for npm publish with files whitelist preventing secret publication.</done>
</task>

</tasks>

<verification>
1. `pnpm build` produces both `dist/index.js` and `dist/sdk.js` with matching `.d.ts` files
2. `pnpm pack --dry-run` shows only dist/, LICENSE, README.md, package.json
3. `pnpm test` -- all tests pass
4. package.json has `exports` map with `.` and `./sdk` subpaths
</verification>

<success_criteria>
- Resource servers can import from 'x402-fac/sdk' subpath
- npm package includes only dist/, LICENSE, README.md (no secrets, tests, or planning docs)
- TypeScript types available for both entry points
</success_criteria>

<output>
After completion, create `.planning/phases/09-documentation-publishing/09-04-SUMMARY.md`
</output>
