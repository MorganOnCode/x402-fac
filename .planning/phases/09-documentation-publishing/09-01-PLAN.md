---
phase: 09-documentation-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/server.ts
  - src/routes/health.ts
  - src/routes/verify.ts
  - src/routes/settle.ts
  - src/routes/status.ts
  - src/routes/supported.ts
  - src/routes/upload.ts
  - src/routes/download.ts
autonomous: true

must_haves:
  truths:
    - "GET /docs serves interactive Swagger UI with all 7 endpoints documented"
    - "OpenAPI spec generated at runtime from existing Zod schemas"
    - "All existing tests continue to pass after schema declarations added"
  artifacts:
    - path: "src/server.ts"
      provides: "Swagger plugin registration before routes"
      contains: "@fastify/swagger"
    - path: "src/routes/verify.ts"
      provides: "Schema declaration for POST /verify"
      contains: "schema:"
    - path: "src/routes/settle.ts"
      provides: "Schema declaration for POST /settle"
      contains: "schema:"
  key_links:
    - from: "src/server.ts"
      to: "@fastify/swagger"
      via: "plugin registration before routes"
      pattern: "register.*swagger"
    - from: "src/routes/verify.ts"
      to: "src/verify/types.ts"
      via: "Zod schemas in route schema declaration"
      pattern: "schema.*body.*VerifyRequestSchema"
---

<objective>
Install @fastify/swagger, @fastify/swagger-ui, and fastify-type-provider-zod. Register Swagger plugins in server.ts before routes. Add `schema` declarations to all 7 route handlers for OpenAPI doc generation. Keep existing `safeParse()` validation logic unchanged (hybrid approach per research).

Purpose: Runtime OpenAPI generation from existing Zod schemas ensures API docs never drift from code.
Output: Interactive Swagger UI at GET /docs, OpenAPI 3.0.3 spec at all endpoints.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-documentation-publishing/09-RESEARCH.md

@src/server.ts
@src/routes/health.ts
@src/routes/verify.ts
@src/routes/settle.ts
@src/routes/status.ts
@src/routes/supported.ts
@src/routes/upload.ts
@src/routes/download.ts
@src/verify/types.ts
@src/settle/types.ts
@src/sdk/types.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Swagger deps and register plugins in server.ts</name>
  <files>package.json, pnpm-lock.yaml, src/server.ts</files>
  <action>
1. Install dependencies:
   ```
   pnpm add @fastify/swagger @fastify/swagger-ui fastify-type-provider-zod
   ```
   NOTE: fastify-type-provider-zod is a runtime dependency (jsonSchemaTransform runs at server init).

2. In `src/server.ts`, add imports at the top:
   ```typescript
   import swagger from '@fastify/swagger';
   import swaggerUi from '@fastify/swagger-ui';
   import { jsonSchemaTransform, serializerCompiler, validatorCompiler } from 'fastify-type-provider-zod';
   ```

3. After `const server = fastify({...})` and BEFORE any plugin registration, add:
   ```typescript
   server.setValidatorCompiler(validatorCompiler);
   server.setSerializerCompiler(serializerCompiler);
   ```

4. After the CORS registration but BEFORE routes (after the `// Custom plugins` section), register Swagger:
   ```typescript
   await server.register(swagger, {
     openapi: {
       openapi: '3.0.3',
       info: {
         title: 'x402 Cardano Payment Facilitator',
         description: 'Cardano x402 payment facilitator API for verifying and settling blockchain payments.',
         version: '1.0.0',
         license: { name: 'Apache-2.0', url: 'https://www.apache.org/licenses/LICENSE-2.0' },
       },
       servers: [
         { url: 'http://localhost:3000', description: 'Development' },
       ],
       tags: [
         { name: 'Health', description: 'Server health and capabilities' },
         { name: 'Facilitator', description: 'Payment verification and settlement' },
         { name: 'Storage', description: 'File upload and download (reference implementation)' },
       ],
     },
     transform: jsonSchemaTransform,
   });

   await server.register(swaggerUi, {
     routePrefix: '/docs',
   });
   ```

   Register swagger AFTER helmet/cors/rate-limit/multipart/custom-plugins but BEFORE routes. The swagger plugin needs to be registered before routes so it can discover their schemas.

5. Verify `pnpm build` succeeds after changes.
  </action>
  <verify>
  `pnpm build` succeeds. `pnpm typecheck` passes. `pnpm test` all 383 tests pass.
  </verify>
  <done>Swagger plugins installed and registered. Server compiles and all tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add schema declarations to all 7 route handlers</name>
  <files>src/routes/health.ts, src/routes/verify.ts, src/routes/settle.ts, src/routes/status.ts, src/routes/supported.ts, src/routes/upload.ts, src/routes/download.ts</files>
  <action>
Add `schema` property to each route's options object for OpenAPI documentation. Keep existing `safeParse()` validation unchanged. The schema declarations are for doc generation only.

**src/routes/health.ts** -- Add to `fastify.get('/health', ...)`:
```typescript
{
  schema: {
    description: 'Check server health and dependency status',
    tags: ['Health'],
    response: {
      200: z.object({
        status: z.enum(['healthy', 'degraded']),
        timestamp: z.string(),
        version: z.string(),
        uptime: z.number(),
        dependencies: z.record(z.string(), z.object({
          status: z.enum(['up', 'down']),
          latency: z.number().optional(),
          error: z.string().optional(),
        })),
      }),
      503: z.object({
        status: z.literal('unhealthy'),
        timestamp: z.string(),
        version: z.string(),
        uptime: z.number(),
        dependencies: z.record(z.string(), z.object({
          status: z.enum(['up', 'down']),
          latency: z.number().optional(),
          error: z.string().optional(),
        })),
      }),
    },
  },
}
```
Import `z` from `'zod'` at the top.

**src/routes/verify.ts** -- Add to `fastify.post('/verify', ...)` options (alongside existing `config`):
```typescript
schema: {
  description: 'Verify a Cardano payment transaction against payment requirements',
  tags: ['Facilitator'],
  body: VerifyRequestSchema,
  response: {
    200: VerifyResponseSchema,
  },
},
```
Import `VerifyResponseSchema` from `'../verify/types.js'` (already have VerifyRequestSchema imported).

**src/routes/settle.ts** -- Add to `fastify.post('/settle', ...)` options:
```typescript
schema: {
  description: 'Submit a signed Cardano transaction for on-chain settlement',
  tags: ['Facilitator'],
  body: SettleRequestSchema,
  response: {
    200: SettleResponseSchema,
  },
},
```
Import `SettleResponseSchema` from `'../settle/types.js'` (already have SettleRequestSchema).

**src/routes/status.ts** -- Add to `fastify.post('/status', ...)` options:
```typescript
schema: {
  description: 'Check transaction confirmation status on Cardano',
  tags: ['Facilitator'],
  body: StatusRequestSchema,
  response: {
    200: StatusResponseSchema,
  },
},
```
Import `StatusResponseSchema` from `'../settle/types.js'` (already have StatusRequestSchema).

**src/routes/supported.ts** -- Add to `fastify.get('/supported', ...)`:
```typescript
{
  schema: {
    description: 'Query facilitator capabilities: supported chains, schemes, and signer addresses',
    tags: ['Health'],
    response: {
      200: SupportedResponseSchema,
    },
  },
}
```
Import `SupportedResponseSchema` from `'../sdk/types.js'`.

**src/routes/upload.ts** -- Add to `fastify.post('/upload', ...)` options:
```typescript
schema: {
  description: 'Upload a file with x402 payment (Payment-Signature header required)',
  tags: ['Storage'],
  response: {
    200: z.object({
      success: z.literal(true),
      cid: z.string(),
      size: z.number(),
    }),
    402: z.object({
      x402Version: z.literal(2),
      error: z.string().nullable(),
      resource: z.object({ description: z.string(), mimeType: z.string(), url: z.string() }),
      accepts: z.array(z.object({ scheme: z.string(), network: z.string(), amount: z.string(), payTo: z.string() })),
    }),
  },
},
```
Import `z` from `'zod'`.

**src/routes/download.ts** -- Add to `fastify.get('/files/:cid', ...)`:
```typescript
{
  schema: {
    description: 'Download a file by content identifier (free, no payment required)',
    tags: ['Storage'],
    params: z.object({
      cid: z.string().describe('Content identifier (SHA-256 hash or IPFS CID)'),
    }),
    response: {
      200: z.string().describe('File binary data (application/octet-stream)'),
      404: z.object({ error: z.string(), message: z.string() }),
    },
  },
}
```
Import `z` from `'zod'`.

IMPORTANT: The schema declarations sit alongside the existing `config` property in route options. For routes that already have a second arg object (like verify, settle, status with `config.rateLimit`), merge `schema` into that same object. For routes that don't have options (like health, supported, download), wrap them in an options object as the second argument.

IMPORTANT: If the type provider's validatorCompiler interferes with the existing safeParse approach, you may need to skip the `setValidatorCompiler` / `setSerializerCompiler` calls and instead just use `transform: jsonSchemaTransform` alone. Test carefully -- if tests break due to Fastify now doing validation before the handler, remove the compiler setters and let the schemas be documentation-only.
  </action>
  <verify>
  `pnpm test` -- all 383 tests pass. `pnpm build` succeeds. `pnpm typecheck` passes. Start the dev server (`pnpm dev`) and verify `curl http://localhost:3000/docs` returns HTML (Swagger UI page) or check that GET /docs/json returns the OpenAPI spec JSON.
  </verify>
  <done>All 7 routes have schema declarations. Swagger UI serves interactive docs at /docs. All existing tests continue to pass.</done>
</task>

</tasks>

<verification>
1. `pnpm test` -- all existing tests pass (383+)
2. `pnpm build` -- compiles successfully
3. `pnpm typecheck` -- zero type errors
4. Start server and verify GET /docs serves Swagger UI
5. Verify GET /docs/json returns OpenAPI 3.0.3 spec with all 7 endpoints
</verification>

<success_criteria>
- Swagger UI accessible at GET /docs
- OpenAPI spec includes all 7 endpoints: /health, /supported, /verify, /settle, /status, /upload, /files/:cid
- Each endpoint has description, tags, and request/response schemas
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-documentation-publishing/09-01-SUMMARY.md`
</output>
