---
phase: 08-resource-server-sdk
plan: 08-02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - src/chain/provider.ts
  - src/routes/supported.ts
  - src/server.ts
  - tests/unit/sdk/facilitator-client.test.ts
  - tests/unit/sdk/payment-required.test.ts
  - tests/integration/supported-route.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /supported returns kinds, extensions, and signers per x402 V2 spec (PROT-03)"
    - "ChainProvider has a getAddress() method that returns the facilitator wallet address"
    - "/supported route derives facilitator address from ChainProvider"
    - "FacilitatorClient unit tests cover all 4 methods, error paths, and timeout"
    - "402 response builder unit tests validate base64 encoding and JSON structure"
    - "/supported integration tests cover happy path, error handling, and schema validation"
  artifacts:
    - path: "src/routes/supported.ts"
      provides: "GET /supported route returning facilitator capabilities"
      exports: ["supportedRoutesPlugin"]
    - path: "tests/unit/sdk/facilitator-client.test.ts"
      provides: "Unit tests for FacilitatorClient (~17 tests)"
      exports: []
    - path: "tests/unit/sdk/payment-required.test.ts"
      provides: "Unit tests for 402 response builder (~8 tests)"
      exports: []
    - path: "tests/integration/supported-route.test.ts"
      provides: "Integration tests for GET /supported (~7 tests)"
      exports: []
  key_links:
    - from: "src/routes/supported.ts"
      to: "src/chain/provider.ts"
      via: "Calls chainProvider.getAddress() for signer list"
      pattern: "fastify.chainProvider.getAddress()"
    - from: "src/routes/supported.ts"
      to: "src/sdk/types.ts"
      via: "Uses SupportedResponseSchema for response typing"
      pattern: "SupportedResponse"
---

<objective>
Add ChainProvider.getAddress(), create GET /supported endpoint (PROT-03), and write unit + integration tests for all SDK core components from 08-01.

Purpose: The /supported endpoint implements PROT-03. The getAddress() method on ChainProvider is needed by /supported to report the facilitator's signer address. The tests validate the SDK core built in 08-01.

Output: `src/routes/supported.ts`; ChainProvider getAddress() method; ~32 tests.
</objective>

<context>
@src/sdk/types.ts
@src/sdk/facilitator-client.ts
@src/sdk/payment-required.ts
@src/chain/provider.ts
@src/chain/lucid-provider.ts
@src/routes/health.ts
@src/server.ts
@src/types/index.ts
@src/config/schema.ts
@tests/integration/verify-route.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAddress() to ChainProvider and create GET /supported route</name>
  <files>src/chain/provider.ts, src/routes/supported.ts, src/server.ts</files>
  <action>
Add a `getAddress()` method to the `ChainProvider` class that returns the facilitator wallet's bech32 address.

Add the following method to the ChainProvider class, after the existing `getLucid()` method:

```typescript
/**
 * Get the facilitator wallet's bech32 address.
 * Derived from the Lucid wallet (configured via seed phrase or private key).
 * Used by /supported endpoint to report signer addresses.
 */
async getAddress(): Promise<string> {
  return await this.lucid.wallet().address();
}
```

Then create `src/routes/supported.ts` implementing the GET /supported endpoint (PROT-03):

```typescript
// GET /supported route -- returns facilitator capabilities (PROT-03).
//
// Reports supported chains, schemes, and signer addresses per the x402 V2 spec.
// Resource servers call this to discover what the facilitator supports.

import type { FastifyPluginCallback } from 'fastify';
import fp from 'fastify-plugin';

import type { CardanoNetwork } from '../chain/types.js';
import { CAIP2_CHAIN_IDS } from '../verify/types.js';
import type { SupportedResponse } from '../sdk/types.js';

const supportedRoutes: FastifyPluginCallback = (fastify, _options, done) => {
  fastify.get('/supported', async (_request, reply) => {
    const chainConfig = fastify.config.chain;
    const network = CAIP2_CHAIN_IDS[chainConfig.network as CardanoNetwork];

    // Get the facilitator's wallet address for the signer list
    let signerAddress: string;
    try {
      signerAddress = await fastify.chainProvider.getAddress();
    } catch (error) {
      fastify.log.error(
        { err: error instanceof Error ? error.message : 'Unknown error' },
        'Failed to derive facilitator address'
      );
      return reply.status(500).send({
        error: 'Internal Server Error',
        message: 'Failed to derive facilitator address',
      });
    }

    const response: SupportedResponse = {
      kinds: [
        {
          x402Version: 2,
          scheme: 'exact',
          network,
        },
      ],
      extensions: [],
      signers: {
        [network]: [signerAddress],
      },
    };

    return reply.status(200).send(response);
  });

  done();
};

export const supportedRoutesPlugin = fp(supportedRoutes, {
  name: 'supported-routes',
  fastify: '5.x',
});
```

Then update `src/server.ts` to register the new route:

1. Add import: `import { supportedRoutesPlugin } from './routes/supported.js';`
2. Add registration after the existing route registrations (after `statusRoutesPlugin`):
   `await server.register(supportedRoutesPlugin);`
  </action>
  <verify>
- `ChainProvider` has a `getAddress()` method returning Promise<string>
- `src/routes/supported.ts` exists and exports `supportedRoutesPlugin`
- Route returns `kinds`, `extensions`, and `signers` fields
- `src/server.ts` imports and registers `supportedRoutesPlugin`
- `pnpm typecheck` passes
  </verify>
  <done>ChainProvider.getAddress() added, GET /supported route created and registered.</done>
</task>

<task type="auto">
  <name>Task 2: Write FacilitatorClient and 402 builder unit tests</name>
  <files>tests/unit/sdk/facilitator-client.test.ts, tests/unit/sdk/payment-required.test.ts</files>
  <action>
Create `tests/unit/sdk/facilitator-client.test.ts` with comprehensive unit tests for the FacilitatorClient:

**Test categories:**

1. **Constructor tests** (~3 tests):
   - Strips trailing slash from baseUrl
   - Uses default timeout (30000ms) when not specified
   - Accepts custom headers

2. **verify() tests** (~4 tests):
   - Sends POST to /verify with correct body
   - Returns parsed VerifyResponse on success
   - Throws on non-200 response
   - Throws on invalid response body (Zod validation failure)

3. **settle() tests** (~3 tests):
   - Sends POST to /settle with correct body
   - Returns parsed SettleResponse on success
   - Throws on facilitator error

4. **status() tests** (~2 tests):
   - Sends POST to /status with correct body
   - Returns parsed StatusResponse on success

5. **supported() tests** (~3 tests):
   - Sends GET to /supported
   - Returns parsed SupportedResponse on success
   - Throws on invalid response

6. **Timeout tests** (~2 tests):
   - Throws timeout error when request exceeds timeout
   - Custom timeout is respected

**Mock strategy:** Use `vi.spyOn(globalThis, 'fetch')` to mock native fetch. Return `Response` objects with JSON bodies.

Then create `tests/unit/sdk/payment-required.test.ts` with unit tests for the 402 response builder:

**Test categories:**

1. **buildPaymentRequired() tests** (~8 tests):
   - Returns a valid base64 string
   - Decoded JSON has x402Version: 2
   - Decoded JSON has correct `accepts` array with scheme, network, amount, payTo, asset
   - Defaults scheme to 'exact' when not provided
   - Defaults asset to 'lovelace' when not provided
   - Defaults maxTimeoutSeconds to 300 when not provided
   - Includes error field when provided
   - Supports custom mimeType and description

Estimated test count: ~25 tests total.
  </action>
  <verify>
- Test files exist at `tests/unit/sdk/facilitator-client.test.ts` and `tests/unit/sdk/payment-required.test.ts`
- All tests pass: `pnpm vitest run tests/unit/sdk/`
- Tests cover success paths, error paths, timeout, and Zod validation
  </verify>
  <done>FacilitatorClient and payment-required unit tests complete.</done>
</task>

<task type="auto">
  <name>Task 3: Write /supported integration tests and verify all</name>
  <files>tests/integration/supported-route.test.ts</files>
  <action>
Create `tests/integration/supported-route.test.ts` following the same pattern as `tests/integration/verify-route.test.ts`:

**Setup:** Mock Lucid, ioredis, and the ChainProvider.getAddress() call.

**Test categories** (~7 tests):

1. **Happy path:**
   - GET /supported returns 200
   - Response has `kinds` array with one entry (x402Version: 2, scheme: 'exact', network: 'cardano:preview')
   - Response has `extensions` as empty array
   - Response has `signers` with the configured network key and wallet address array

2. **Content type:**
   - Response Content-Type is application/json

3. **Error handling:**
   - Returns 500 when getAddress() throws
   - Response doesn't expose internal error details in production mode

4. **Schema validation:**
   - Response validates against SupportedResponseSchema

Then run the full verification suite:

1. `pnpm typecheck` -- ensure no type errors with new SDK types and route
2. `pnpm lint` -- ensure no lint violations
3. `pnpm vitest run` -- ensure all existing + new tests pass
4. Verify total test count increased by ~32

Fix any issues that arise.
  </action>
  <verify>
- Test file exists at `tests/integration/supported-route.test.ts`
- All tests pass: `pnpm vitest run tests/integration/supported-route.test.ts`
- `pnpm typecheck` exits 0
- `pnpm lint` exits 0
- `pnpm vitest run` exits 0 with all tests passing
  </verify>
  <done>All tests pass, typecheck clean, lint clean. Plan 08-02 complete.</done>
</task>

</tasks>

<verification>
- `src/routes/supported.ts` exists and is registered in server.ts
- `ChainProvider.getAddress()` method exists
- `pnpm typecheck` passes
- `pnpm lint` passes
- All tests pass including new unit tests (facilitator-client, payment-required) and integration test (supported-route)
- GET /supported returns valid SupportedResponse JSON
</verification>

<success_criteria>
GET /supported returns the facilitator's capabilities including the wallet signer address (PROT-03). All SDK core components from 08-01 are tested: FacilitatorClient with ~17 tests, 402 builder with ~8 tests, /supported with ~7 tests. All ~32 new tests pass. Ready for Plan 08-03 (storage layer).
</success_criteria>

<output>
After completion, create `.planning/phases/08-resource-server-sdk/08-02-SUMMARY.md`
</output>
