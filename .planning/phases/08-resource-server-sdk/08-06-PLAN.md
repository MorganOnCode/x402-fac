---
phase: 08-resource-server-sdk
plan: 08-06
type: execute
wave: 4
depends_on:
  - 08-05
files_modified:
  - examples/client.ts
  - examples/README.md
  - config/config.example.json
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - "Example client demonstrates the complete x402 payment flow end-to-end"
    - "Client requests protected resource -> receives 402 -> parses payment requirements"
    - "Client builds and signs a Cardano transaction using Lucid Evolution"
    - "Client retries with Payment-Signature header containing base64 encoded payment"
    - "Client receives 200 with CID after successful payment and upload"
    - "Example code does not include real credentials (uses placeholders)"
    - "README explains how to configure and run the example"
    - "ROADMAP.md updated to reflect Phase 8 completion"
  artifacts:
    - path: "examples/client.ts"
      provides: "CLI example demonstrating the full x402 Cardano payment cycle"
      exports: []
    - path: "examples/README.md"
      provides: "Instructions for running the example client"
      exports: []
  key_links:
    - from: "examples/client.ts"
      to: "src/sdk/types.ts"
      via: "Uses PaymentRequiredResponse and PaymentSignaturePayload types for wire format"
      pattern: "base64 decode Payment-Required header -> parse accepts -> build Payment-Signature"
    - from: "examples/client.ts"
      to: "@lucid-evolution/lucid"
      via: "Uses Lucid Evolution to build and sign Cardano transactions"
      pattern: "lucid.newTx().pay.ToAddress().complete().sign.withWallet().complete()"
---

<objective>
Create an example client that demonstrates the complete x402 payment cycle: request a protected resource, receive 402, build and sign a Cardano payment transaction, retry with payment, receive the resource. Also update the ROADMAP to reflect Phase 8 completion.

Purpose: This is the culmination of Phase 8 -- a working example that proves the entire end-to-end flow functions. It serves as both a validation tool and a reference for developers building x402 clients for Cardano.

Output: `examples/client.ts`, `examples/README.md`, updated roadmap.
</objective>

<context>
@src/sdk/types.ts
@src/sdk/payment-required.ts
@src/routes/upload.ts
@src/routes/download.ts
@src/routes/supported.ts
@.planning/ROADMAP.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create example client</name>
  <files>examples/client.ts</files>
  <action>
Create `examples/client.ts` -- a standalone CLI script demonstrating the full x402 payment cycle.

The script should:
1. Check server health (GET /health)
2. Query capabilities (GET /supported)
3. Request POST /upload without payment -> receive 402
4. Parse Payment-Required header for payment requirements
5. Build and sign a Cardano transaction using Lucid Evolution
6. Retry POST /upload with Payment-Signature header -> receive 200 + CID
7. Download the file for free (GET /files/:cid)

Key design decisions:
- Standalone script, runnable with `tsx examples/client.ts`
- Uses environment variables for credentials (BLOCKFROST_KEY, SEED_PHRASE) -- no secrets in code
- Step-by-step output showing the full flow for learning purposes
- Creates a test file if no FILE_PATH provided
- Handles both ADA and token payments
- Downloads the file after upload to verify the round-trip
- Uses native fetch (Node 20+)

Environment variables:
- BLOCKFROST_KEY (required) -- Blockfrost project ID for preview testnet
- SEED_PHRASE (required) -- 24-word seed phrase for funded wallet
- SERVER_URL (optional, default: http://localhost:3000) -- Resource server URL
- FILE_PATH (optional) -- Path to file to upload
  </action>
  <verify>
- `examples/client.ts` exists
- No hardcoded credentials (uses environment variables)
- All steps of the x402 flow are implemented
  </verify>
  <done>Example client created demonstrating the complete x402 payment flow.</done>
</task>

<task type="auto">
  <name>Task 2: Create example README and verify config</name>
  <files>examples/README.md, config/config.example.json</files>
  <action>
Create `examples/README.md` with instructions for running the example:
- Prerequisites (Node.js 20+, running server, funded wallet, Blockfrost key)
- How to get a Blockfrost API key
- How to get a funded preview wallet
- Step-by-step running instructions
- Environment variables table
- Expected output example
- Security notes (never commit seed phrase or API keys)

Verify `config/config.example.json` has the complete storage section from 08-03 and all Phase 8 additions are present.
  </action>
  <verify>
- `examples/README.md` exists with setup and running instructions
- Warns about credential security
- Shows expected output
- `config/config.example.json` is complete
  </verify>
  <done>Example README created and config example verified.</done>
</task>

<task type="auto">
  <name>Task 3: Update ROADMAP and final verification</name>
  <files>.planning/ROADMAP.md</files>
  <action>
Update `.planning/ROADMAP.md` to reflect Phase 8 completion:

1. Update the Phase 8 plan list:
```
Plans:
- [x] 08-01-PLAN.md -- SDK core: types, FacilitatorClient, 402 builder, barrel (wave 1)
- [x] 08-02-PLAN.md -- ChainProvider.getAddress, GET /supported, SDK tests (wave 1)
- [x] 08-03-PLAN.md -- Storage layer: interface, FsBackend, IpfsBackend, config (wave 2)
- [x] 08-04-PLAN.md -- Payment gate middleware, Fastify type augmentation (wave 2)
- [x] 08-05-PLAN.md -- POST /upload, GET /files/:cid routes, server integration (wave 3)
- [x] 08-06-PLAN.md -- Example client, README, roadmap update (wave 4)
```

2. Update the progress table:
```
| 8. Resource Server SDK | 6/6 | Complete | YYYY-MM-DD |
```

3. Update **Plans**: `6 plans in 4 waves`

4. Mark security checks as done

Then run final verification:
1. `pnpm typecheck` -- ensure everything compiles
2. `pnpm lint` -- ensure code quality
3. `pnpm vitest run` -- ensure all tests pass

Verify Phase 8 success criteria:
- [x] Resource server returns 402 with Cardano payment requirements
- [x] Client can construct, sign, and submit payment (example code)
- [x] Resource server grants access after facilitator confirms settlement
- [x] End-to-end flow demonstrated (example client)
- [x] SDK pattern is reusable (FacilitatorClient + createPaymentGate)
  </action>
  <verify>
- ROADMAP.md shows Phase 8 as complete with 6/6 plans
- `pnpm typecheck` exits 0
- `pnpm lint` exits 0
- `pnpm vitest run` exits 0 with all tests passing
- Phase 8 success criteria checklist complete
  </verify>
  <done>Phase 8 complete. All 6 plans executed, all tests pass, all success criteria met.</done>
</task>

</tasks>

<verification>
- `examples/client.ts` exists and demonstrates the full x402 flow
- `examples/README.md` exists with setup and usage instructions
- No real credentials in example code or README
- ROADMAP.md updated with Phase 8 completion
- All tests pass (existing + new from Plans 08-01 through 08-05)
- `pnpm typecheck` and `pnpm lint` pass
</verification>

<success_criteria>
The example client proves the complete x402 Cardano payment flow works end-to-end. A developer can follow the README to set up a funded testnet wallet, run the server, and execute the example client to see: 402 response -> payment construction -> signed transaction -> settlement -> file storage -> free download. Phase 8 is complete and ready for Phase 9 (Documentation & Publishing).
</success_criteria>

<output>
After completion, create `.planning/phases/08-resource-server-sdk/08-06-SUMMARY.md`
</output>
