---
phase: 08-resource-server-sdk
plan: 08-04
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - src/sdk/payment-gate.ts
  - src/sdk/index.ts
  - src/types/index.ts
  - tests/unit/sdk/payment-gate.test.ts
autonomous: true

must_haves:
  truths:
    - "Payment gate middleware extracts and decodes Payment-Signature header (base64 JSON)"
    - "Payment gate returns 402 with Payment-Required header when no payment provided"
    - "Payment gate calls FacilitatorClient.verify() then settle() in sequence"
    - "Payment gate rejects requests when verification or settlement fails"
    - "Payment gate attaches settlement result to request for downstream route handlers"
    - "Settle-before-execution pattern enforced (SECU-04) -- settlement completes before route handler runs"
    - "Fastify type augmentation adds x402Settlement to FastifyRequest and storage to FastifyInstance"
  artifacts:
    - path: "src/sdk/payment-gate.ts"
      provides: "createPaymentGate() Fastify preHandler plugin for x402 payment enforcement"
      exports: ["createPaymentGate", "PaymentGateOptions"]
    - path: "tests/unit/sdk/payment-gate.test.ts"
      provides: "Unit tests for payment gate middleware (~14 tests)"
      exports: []
  key_links:
    - from: "src/sdk/payment-gate.ts"
      to: "src/sdk/facilitator-client.ts"
      via: "Calls verify() and settle() on the provided FacilitatorClient"
      pattern: "options.facilitator.verify()|options.facilitator.settle()"
    - from: "src/sdk/payment-gate.ts"
      to: "src/sdk/payment-required.ts"
      via: "Uses reply402() to send 402 responses"
      pattern: "reply402(reply, ...)"
    - from: "src/sdk/payment-gate.ts"
      to: "src/sdk/types.ts"
      via: "Decodes Payment-Signature header using PaymentSignaturePayloadSchema"
      pattern: "PaymentSignaturePayloadSchema.safeParse()"
---

<objective>
Build the payment gate middleware and Fastify type augmentation. The payment gate is the x402 enforcement mechanism -- it intercepts requests, checks for payment, and verifies/settles before allowing access.

Purpose: This is the critical building block for the reference implementation routes (Plan 08-05). The payment gate implements the settle-before-execution pattern required by SECU-04.

Output: `src/sdk/payment-gate.ts`, updated Fastify type augmentation, updated SDK barrel; ~14 tests.
</objective>

<context>
@src/sdk/facilitator-client.ts
@src/sdk/payment-required.ts
@src/sdk/types.ts
@src/sdk/index.ts
@src/types/index.ts
@src/verify/types.ts
@src/settle/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment gate middleware and update Fastify types</name>
  <files>src/sdk/payment-gate.ts, src/sdk/index.ts, src/types/index.ts</files>
  <action>
Create `src/sdk/payment-gate.ts` -- a Fastify preHandler that enforces x402 payment:

```typescript
// Payment gate middleware for x402 V2.
//
// Intercepts requests to protected routes and enforces payment.
// Flow: check header -> decode -> verify -> settle -> allow through.
// Implements settle-before-execution (SECU-04): payment is confirmed on-chain
// BEFORE the route handler runs.

import type { FastifyReply, FastifyRequest, preHandlerHookHandler } from 'fastify';

import type { FacilitatorClient } from './facilitator-client.js';
import { reply402 } from './payment-required.js';
import type { PaymentRequiredOptions } from './payment-required.js';
import { PaymentSignaturePayloadSchema } from './types.js';
import type { PaymentResponseHeader } from './types.js';

export interface PaymentGateOptions {
  /** FacilitatorClient instance for verify/settle calls */
  facilitator: FacilitatorClient;
  /** Bech32 recipient address for payments */
  payTo: string;
  /** Payment amount in smallest unit (lovelace) as string */
  amount: string;
  /** CAIP-2 chain ID (e.g. "cardano:preview") */
  network: string;
  /** Asset identifier (default: "lovelace") */
  asset?: string;
  /** Max timeout seconds (default: 300) */
  maxTimeoutSeconds?: number;
  /** Resource description for 402 response */
  description?: string;
  /** Resource MIME type (default: "application/octet-stream") */
  mimeType?: string;
}

/**
 * Decode the Payment-Signature header from a request.
 * Returns the parsed payload or null if invalid.
 */
function decodePaymentSignature(headerValue: string): ReturnType<typeof PaymentSignaturePayloadSchema.safeParse> {
  try {
    const json = Buffer.from(headerValue, 'base64').toString('utf-8');
    const parsed = JSON.parse(json) as unknown;
    return PaymentSignaturePayloadSchema.safeParse(parsed);
  } catch {
    return { success: false, error: { message: 'Invalid base64 or JSON' } } as ReturnType<typeof PaymentSignaturePayloadSchema.safeParse>;
  }
}

/**
 * Create a Fastify preHandler that enforces x402 payment.
 *
 * When applied to a route, this middleware:
 * 1. Checks for the Payment-Signature header
 * 2. If absent: returns 402 with payment requirements
 * 3. If present: decodes, verifies, settles via the facilitator
 * 4. On success: attaches settlement result to request and allows through
 * 5. On failure: returns 402 with error details
 *
 * Settlement happens BEFORE the route handler (settle-before-execution per SECU-04).
 */
export function createPaymentGate(options: PaymentGateOptions): preHandlerHookHandler {
  const paymentRequiredOptions: PaymentRequiredOptions = {
    network: options.network,
    amount: options.amount,
    payTo: options.payTo,
    scheme: 'exact',
    asset: options.asset ?? 'lovelace',
    maxTimeoutSeconds: options.maxTimeoutSeconds ?? 300,
    description: options.description,
    mimeType: options.mimeType ?? 'application/octet-stream',
  };

  return async function paymentGateHandler(
    request: FastifyRequest,
    reply: FastifyReply
  ): Promise<void> {
    // 1. Check for Payment-Signature header
    const paymentHeader = request.headers['payment-signature'] as string | undefined;

    if (!paymentHeader) {
      // Return 402 with payment requirements
      paymentRequiredOptions.url = request.url;
      reply402(reply, paymentRequiredOptions);
      return;
    }

    // 2. Decode and validate payment payload
    const decoded = decodePaymentSignature(paymentHeader);

    if (!decoded.success) {
      paymentRequiredOptions.url = request.url;
      paymentRequiredOptions.error = 'Invalid Payment-Signature header';
      reply402(reply, paymentRequiredOptions);
      return;
    }

    const payload = decoded.data;

    // 3. Build verify request from the payment payload
    // Map the SDK's `amount` field to the facilitator's `maxAmountRequired` field
    const verifyRequest = {
      paymentPayload: {
        x402Version: 2 as const,
        scheme: 'exact' as const,
        network: payload.accepted.network,
        payload: payload.payload,
      },
      paymentRequirements: {
        scheme: 'exact' as const,
        network: options.network,
        maxAmountRequired: options.amount,
        payTo: options.payTo,
        maxTimeoutSeconds: options.maxTimeoutSeconds ?? 300,
        asset: options.asset ?? 'lovelace',
      },
    };

    // 4. Verify with facilitator
    let verifyResult;
    try {
      verifyResult = await options.facilitator.verify(verifyRequest);
    } catch (error) {
      request.log.error(
        { err: error instanceof Error ? error.message : 'Unknown error' },
        'Payment verification failed'
      );
      paymentRequiredOptions.url = request.url;
      paymentRequiredOptions.error = 'Payment verification failed';
      reply402(reply, paymentRequiredOptions);
      return;
    }

    if (!verifyResult.isValid) {
      paymentRequiredOptions.url = request.url;
      paymentRequiredOptions.error = verifyResult.invalidReason ?? 'Payment verification failed';
      reply402(reply, paymentRequiredOptions);
      return;
    }

    // 5. Settle with facilitator (SECU-04: settle before execution)
    let settleResult;
    try {
      settleResult = await options.facilitator.settle({
        transaction: payload.payload.transaction,
        paymentRequirements: {
          scheme: 'exact' as const,
          network: options.network,
          maxAmountRequired: options.amount,
          payTo: options.payTo,
          maxTimeoutSeconds: options.maxTimeoutSeconds ?? 300,
          asset: options.asset ?? 'lovelace',
        },
      });
    } catch (error) {
      request.log.error(
        { err: error instanceof Error ? error.message : 'Unknown error' },
        'Payment settlement failed'
      );
      paymentRequiredOptions.url = request.url;
      paymentRequiredOptions.error = 'Payment settlement failed';
      reply402(reply, paymentRequiredOptions);
      return;
    }

    if (!settleResult.success) {
      paymentRequiredOptions.url = request.url;
      paymentRequiredOptions.error = `Settlement failed: ${settleResult.reason ?? 'unknown'}`;
      reply402(reply, paymentRequiredOptions);
      return;
    }

    // 6. Attach settlement info to request for downstream handlers
    const paymentResponse: PaymentResponseHeader = {
      success: true,
      transaction: settleResult.transaction,
      network: settleResult.network,
    };

    // Store on request for route handlers to access
    (request as FastifyRequest & { x402Settlement?: PaymentResponseHeader }).x402Settlement = paymentResponse;

    // Set X-Payment-Response header on the reply
    const responseHeaderValue = Buffer.from(JSON.stringify(paymentResponse)).toString('base64');
    void reply.header('X-Payment-Response', responseHeaderValue);

    // Allow through to the route handler
  };
}
```

Update `src/sdk/index.ts` to export the new payment gate:

Add these exports:
```typescript
export { createPaymentGate } from './payment-gate.js';
export type { PaymentGateOptions } from './payment-gate.js';
```

Update `src/types/index.ts` to augment FastifyRequest with x402Settlement and FastifyInstance with storage:

```typescript
import type { PaymentResponseHeader } from '../sdk/types.js';
import type { StorageBackend } from '../storage/types.js';
```

Add to the `FastifyInstance` interface:
```typescript
storage: StorageBackend;
```

Add a new `FastifyRequest` augmentation:
```typescript
interface FastifyRequest {
  x402Settlement?: PaymentResponseHeader;
}
```
  </action>
  <verify>
- `src/sdk/payment-gate.ts` exists and exports `createPaymentGate()`
- Returns a Fastify preHandler function
- Checks for Payment-Signature header, returns 402 when absent
- Calls verify then settle on the FacilitatorClient
- Settle happens before the route handler (SECU-04)
- `src/sdk/index.ts` exports createPaymentGate
- `src/types/index.ts` augments FastifyRequest and FastifyInstance
- `pnpm typecheck` passes
  </verify>
  <done>Payment gate middleware created with Fastify type augmentation.</done>
</task>

<task type="auto">
  <name>Task 2: Write payment gate middleware unit tests</name>
  <files>tests/unit/sdk/payment-gate.test.ts</files>
  <action>
Create `tests/unit/sdk/payment-gate.test.ts` with comprehensive tests for the payment gate.

**Mock strategy:** Create mock FacilitatorClient, mock FastifyRequest/Reply objects.

**Test categories:**

1. **No payment header** (~2 tests):
   - Returns 402 status
   - Sets Payment-Required header (base64 encoded)

2. **Invalid payment header** (~3 tests):
   - Invalid base64 returns 402
   - Invalid JSON returns 402
   - JSON not matching schema returns 402

3. **Verification failure** (~2 tests):
   - FacilitatorClient.verify() returns isValid: false -> returns 402 with invalidReason
   - FacilitatorClient.verify() throws -> returns 402

4. **Settlement failure** (~2 tests):
   - FacilitatorClient.settle() returns success: false -> returns 402
   - FacilitatorClient.settle() throws -> returns 402

5. **Success flow** (~3 tests):
   - Verify and settle both succeed -> handler is not called with a reply (passes through)
   - x402Settlement attached to request
   - X-Payment-Response header set on reply

6. **Payment-Signature header encoding** (~2 tests):
   - Correct base64-encoded JSON decoded and parsed
   - Verify request constructed with correct field mapping (amount -> maxAmountRequired)

**Mock helpers:**

```typescript
function createMockRequest(headers: Record<string, string> = {}): FastifyRequest {
  return {
    headers,
    url: '/test',
    log: { error: vi.fn(), info: vi.fn(), warn: vi.fn(), debug: vi.fn() },
  } as unknown as FastifyRequest;
}

function createMockReply(): FastifyReply & { statusCode: number; headers: Record<string, string>; sent: boolean } {
  const mock = {
    statusCode: 200,
    headers: {} as Record<string, string>,
    sent: false,
    status: vi.fn().mockImplementation((code: number) => { mock.statusCode = code; return mock; }),
    header: vi.fn().mockImplementation((key: string, value: string) => { mock.headers[key] = value; return mock; }),
    send: vi.fn().mockImplementation(() => { mock.sent = true; }),
  };
  return mock as unknown as FastifyReply & typeof mock;
}

function createPaymentSignature(overrides = {}): string {
  const payload = {
    x402Version: 2,
    accepted: {
      scheme: 'exact',
      network: 'cardano:preview',
      amount: '2000000',
      payTo: 'addr_test1qz_test',
      maxTimeoutSeconds: 300,
      asset: 'lovelace',
      extra: null,
    },
    payload: {
      transaction: 'base64txdata',
      payer: 'addr_test1qz_payer',
    },
    resource: {
      description: 'Test resource',
      mimeType: 'application/json',
      url: 'http://localhost/test',
    },
    ...overrides,
  };
  return Buffer.from(JSON.stringify(payload)).toString('base64');
}
```

Estimated test count: ~14 tests.
  </action>
  <verify>
- Test file exists at `tests/unit/sdk/payment-gate.test.ts`
- All tests pass: `pnpm vitest run tests/unit/sdk/payment-gate.test.ts`
- Tests cover no-header, invalid-header, verify-fail, settle-fail, and success paths
  </verify>
  <done>Payment gate unit tests complete with ~14 tests covering all paths.</done>
</task>

<task type="auto">
  <name>Task 3: Verify all tests pass and typecheck</name>
  <files></files>
  <action>
Run the full verification suite:

1. `pnpm typecheck` -- ensure no type errors
2. `pnpm lint` -- ensure no lint violations
3. `pnpm vitest run` -- ensure all existing + new tests pass
4. Verify new test files are detected and passing

Fix any issues that arise.
  </action>
  <verify>
- `pnpm typecheck` exits 0
- `pnpm lint` exits 0
- `pnpm vitest run` exits 0 with all tests passing
- Payment gate tests visible in output
  </verify>
  <done>All tests pass, typecheck clean, lint clean. Plan 08-04 complete.</done>
</task>

</tasks>

<verification>
- `src/sdk/payment-gate.ts` exists and creates a preHandler that enforces x402 payment
- `src/types/index.ts` augments FastifyRequest and FastifyInstance for x402
- Payment gate uses settle-before-execution (SECU-04)
- All ~14 new tests pass
- `pnpm typecheck` and `pnpm lint` pass
</verification>

<success_criteria>
The payment gate middleware is functional: it extracts Payment-Signature headers, calls verify/settle, and enforces settle-before-execution. Fastify types are augmented for storage and x402Settlement. All building blocks ready for Plan 08-05 (upload/download routes).
</success_criteria>

<output>
After completion, create `.planning/phases/08-resource-server-sdk/08-04-SUMMARY.md`
</output>
