---
phase: 02-chain-provider
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [package.json, pnpm-lock.yaml]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Server starts with `pnpm dev` without ESM module resolution errors"
    - "Config validation rejects missing chain section (Zod error, not import crash)"
    - "Health endpoint returns Redis status when server is running"
  artifacts:
    - path: "package.json"
      provides: "pnpm override for libsodium-wrappers-sumo"
      contains: "libsodium-wrappers-sumo"
  key_links:
    - from: "package.json (pnpm.overrides)"
      to: "node_modules/.pnpm/libsodium-wrappers-sumo@0.8.2"
      via: "pnpm install resolves override"
      pattern: "libsodium-wrappers-sumo.*0\\.8"
---

<objective>
Fix the libsodium-wrappers-sumo ESM packaging bug that crashes `pnpm dev` (tsx runtime) at import time.

Purpose: Phase 2 code is complete and all 91 tests pass, but the dev server cannot start due to a transitive dependency bug. libsodium-wrappers-sumo@0.7.16 has a broken ESM entry that imports `./libsodium-sumo.mjs` via relative path, but the file is not published in the package. Version 0.8.2 fixes this by using a package-level import (`libsodium-sumo`) instead. This blocks all UAT tests that require a running server (tests 3, 4, 5, 6) and blocks Phase 3 development.

Output: Working `pnpm dev` that starts the server without import errors.
</objective>

<execution_context>
@/Users/morgan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/libsodium-esm-resolution-failure.md
@.planning/phases/02-chain-provider/02-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Override libsodium-wrappers-sumo to 0.8.2 and verify server starts</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
    1. Add a pnpm override in package.json to force libsodium-wrappers-sumo to 0.8.2.
       The `pnpm` section already exists in package.json (has `onlyBuiltDependencies`).
       Add an `overrides` field inside the existing `pnpm` section:

       ```json
       "pnpm": {
         "onlyBuiltDependencies": [...],
         "overrides": {
           "libsodium-wrappers-sumo": "0.8.2"
         }
       }
       ```

    2. Run `pnpm install` to apply the override. This will update pnpm-lock.yaml
       to resolve libsodium-wrappers-sumo@0.8.2 for all transitive consumers
       (@cardano-sdk/crypto -> @lucid-evolution/utils -> @lucid-evolution/lucid).

    3. Verify the override took effect:
       - `pnpm ls libsodium-wrappers-sumo` should show 0.8.2 (not 0.7.16)
       - Check that dist/modules-sumo-esm/libsodium-wrappers.mjs in the installed
         package uses `import e from"libsodium-sumo"` (package import, not relative)

    4. Run `pnpm build` to confirm the build still succeeds with the new version.

    5. Run `pnpm test` to confirm all 91 tests still pass.

    6. Run `pnpm dev` and wait for the server to start (look for the Fastify listening log).
       The server should start without ERR_MODULE_NOT_FOUND errors.
       Stop the server after confirming startup succeeds (Ctrl+C or kill the process).

    Important: Do NOT upgrade @cardano-sdk/crypto or @lucid-evolution packages. Only
    override the transitive libsodium-wrappers-sumo version. Upgrading Lucid or its
    dependencies could introduce breaking API changes.
  </action>
  <verify>
    - `pnpm ls libsodium-wrappers-sumo` shows version 0.8.2
    - `pnpm build` exits 0
    - `pnpm test` exits 0 with 91+ tests passing
    - `pnpm dev` starts the server without ERR_MODULE_NOT_FOUND (check first ~5 seconds of output for listening log or absence of crash)
  </verify>
  <done>
    Server starts via `pnpm dev` without libsodium ESM import errors. Build and all tests continue to pass. UAT tests 3, 4, 5, 6 are unblocked.
  </done>
</task>

</tasks>

<verification>
- `pnpm dev` starts and logs the Fastify listening message (no ERR_MODULE_NOT_FOUND)
- `pnpm build` completes with zero errors
- `pnpm test` passes all 91+ tests
- `pnpm ls libsodium-wrappers-sumo` confirms 0.8.2
</verification>

<success_criteria>
- Development server starts and runs with the chain layer fully initialized
- Config validation errors surface correctly (Zod errors, not import crashes)
- No regression in build or test suite
</success_criteria>

<output>
After completion, create `.planning/phases/02-chain-provider/02-06-SUMMARY.md`
</output>
