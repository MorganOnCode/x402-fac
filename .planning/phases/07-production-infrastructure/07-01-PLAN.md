---
phase: 07-production-infrastructure
plan: 07-01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "Every PR runs lint + typecheck + test + build automatically via GitHub Actions"
    - "CI fails on coverage threshold violations (80/65/75/80)"
    - "Dependency vulnerability scanning runs in CI (pnpm audit)"
    - "CI pipeline does not expose secrets in logs"
    - "pnpm store is cached for faster CI runs"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline for lint, typecheck, test, build, dependency audit"
      exports: []
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "Runs pnpm scripts defined in package.json"
      pattern: "pnpm lint|pnpm typecheck|pnpm test|pnpm build"
---

<objective>
Create a GitHub Actions CI/CD pipeline that runs lint, typecheck, test (with coverage enforcement), build, and dependency audit on every PR and push to main.

Purpose: The facilitator has 298 tests, coverage thresholds, and lint/typecheck scripts but no CI. Every merge could silently break something. This plan makes the test suite run automatically on every change.

Output: `.github/workflows/ci.yml`
</objective>

<context>
@package.json
@vitest.config.ts
@.github/dependabot.yml
@tsconfig.json
@tsup.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with the following configuration:

**Triggers:**
- Push to `main` branch
- Pull requests targeting `main` branch

**Environment:**
- Ubuntu latest
- Node 20 (matches engines requirement)
- pnpm 10.8.1 (matches packageManager field)

**Steps (single job for simplicity — all steps are fast):**

1. **Checkout** — `actions/checkout@v4`

2. **Setup pnpm** — `pnpm/action-setup@v4` (reads version from packageManager in package.json)

3. **Setup Node** — `actions/setup-node@v4` with `node-version: 20` and `cache: 'pnpm'` (caches pnpm store automatically)

4. **Install dependencies** — `pnpm install --frozen-lockfile` (fail if lockfile is stale)

5. **Lint** — `pnpm lint`

6. **Type check** — `pnpm typecheck`

7. **Test with coverage** — `pnpm test:coverage`
   - This runs vitest with coverage thresholds (80/65/75/80). If thresholds fail, CI fails.
   - The vitest config already has `thresholds` set and `json` reporter enabled.

8. **Build** — `pnpm build`

9. **Dependency audit** — `pnpm audit --audit-level=high`
   - Fail CI if any high or critical vulnerabilities exist.
   - Use `continue-on-error: false` (default).

**Security considerations:**
- No secrets needed: all tests use mocked Blockfrost/Redis. Config is loaded from test setup, not `config/config.json`.
- Don't use `actions/cache` for node_modules — pnpm store cache via `setup-node` is sufficient and simpler.
- No Docker services needed: tests mock Redis, no IPFS in tests.

**Workflow file:**

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  ci:
    name: Lint, Test, Build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm typecheck

      - name: Test with coverage
        run: pnpm test:coverage

      - name: Build
        run: pnpm build

      - name: Dependency audit
        run: pnpm audit --audit-level=high
```

Notes:
- `permissions: contents: read` follows least-privilege (no write access needed).
- `timeout-minutes: 10` prevents runaway jobs.
- `pnpm/action-setup@v4` auto-reads the `packageManager` field from `package.json` — no version pinning needed in the workflow.
- `--frozen-lockfile` ensures CI uses exactly what's in `pnpm-lock.yaml`.
  </action>
  <verify>
- `.github/workflows/ci.yml` exists and is valid YAML
- Workflow triggers on push to main and PRs to main
- All 5 steps present: lint, typecheck, test:coverage, build, audit
- No secrets referenced in the workflow
- `permissions: contents: read` set
  </verify>
  <done>GitHub Actions CI pipeline created with lint, typecheck, test+coverage, build, and dependency audit.</done>
</task>

</tasks>

<verification>
- `.github/workflows/ci.yml` is valid YAML (validate with `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"`)
- Workflow structure matches GitHub Actions schema
- No hardcoded secrets or tokens
- pnpm version derived from package.json (not hardcoded)
- Coverage enforcement via existing vitest thresholds (no separate coverage action needed)
</verification>

<success_criteria>
A single push to main or PR will automatically validate the entire codebase: lint, types, 298 tests with coverage thresholds, build, and dependency audit. No manual testing steps required. Ready for Plan 07-02 (Docker).
</success_criteria>

<output>
After completion, create `.planning/phases/07-production-infrastructure/07-01-SUMMARY.md`
</output>
