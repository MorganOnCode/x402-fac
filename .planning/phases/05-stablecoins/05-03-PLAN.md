---
phase: 05-stablecoins
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/routes/verify.ts
  - src/routes/settle.ts
  - src/verify/index.ts
  - tests/integration/verify-route.test.ts
  - tests/integration/settle-route.test.ts
autonomous: true

must_haves:
  truths:
    - "/verify accepts token payments and threads asset into VerifyContext"
    - "/verify defaults to ADA when asset is omitted (backward compatibility)"
    - "/settle threads asset into VerifyContext for re-verification"
    - "Unsupported token requests return isValid:false with reason 'unsupported_token' from /verify"
    - "Token amount verification works end-to-end through route -> orchestrator -> checks"
    - "Min UTXO check runs for token and ADA payments through the route"
  artifacts:
    - path: "src/routes/verify.ts"
      provides: "Updated VerifyContext assembly with asset and getMinUtxoLovelace"
      contains: "asset:"
    - path: "src/routes/settle.ts"
      provides: "Updated VerifyContext assembly with asset and getMinUtxoLovelace"
      contains: "asset:"
    - path: "tests/integration/verify-route.test.ts"
      provides: "Integration tests for token payment verification via /verify"
    - path: "tests/integration/settle-route.test.ts"
      provides: "Integration tests for token payment settlement via /settle"
  key_links:
    - from: "src/routes/verify.ts"
      to: "src/verify/types.ts"
      via: "VerifyContext.asset populated from paymentRequirements.asset"
      pattern: "asset: paymentRequirements\\.asset"
    - from: "src/routes/verify.ts"
      to: "src/chain/provider.ts"
      via: "getMinUtxoLovelace callback from ChainProvider"
      pattern: "getMinUtxoLovelace.*chainProvider"
    - from: "src/routes/settle.ts"
      to: "src/verify/types.ts"
      via: "VerifyContext.asset populated from paymentRequirements.asset"
      pattern: "asset: paymentRequirements\\.asset"
---

<objective>
Wire the stablecoin-extended verification pipeline into the /verify and /settle route handlers. Add integration tests covering token payment flows.

Purpose: Complete the end-to-end token payment flow by threading the asset field from PaymentRequirements into VerifyContext and providing the getMinUtxoLovelace callback. This is the final plan -- after this, stablecoin payments work through the full verify/settle pipeline.

Output: Updated `src/routes/verify.ts`, updated `src/routes/settle.ts`, updated `src/verify/index.ts`, updated integration tests
</objective>

<execution_context>
@/Users/morgan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stablecoins/05-CONTEXT.md
@.planning/phases/05-stablecoins/05-RESEARCH.md
@.planning/phases/05-stablecoins/05-01-SUMMARY.md
@.planning/phases/05-stablecoins/05-02-SUMMARY.md
@src/routes/verify.ts
@src/routes/settle.ts
@src/verify/types.ts
@src/verify/checks.ts
@src/verify/token-registry.ts
@src/chain/provider.ts
@tests/integration/verify-route.test.ts
@tests/integration/settle-route.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update /verify and /settle route handlers with asset threading</name>
  <files>src/routes/verify.ts, src/routes/settle.ts, src/verify/index.ts</files>
  <action>
**1. Update `src/routes/verify.ts` -- add asset and getMinUtxoLovelace to VerifyContext:**

In the VerifyContext assembly block (around line 36-49), add two new fields:

```typescript
const ctx: VerifyContext = {
  // ... existing fields (scheme, network, payTo, requiredAmount, etc.) ...

  // NEW: Asset identifier from PaymentRequirements (defaults to 'lovelace' via Zod schema)
  asset: paymentRequirements.asset,

  // NEW: Min UTXO callback from ChainProvider
  getMinUtxoLovelace: (numAssets: number) => fastify.chainProvider.getMinUtxoLovelace(numAssets),

  // ... existing fields continue (requestedAt, getCurrentSlot, etc.) ...
};
```

Place `asset` after `maxTimeoutSeconds` and `getMinUtxoLovelace` after `getCurrentSlot` to maintain logical grouping. The `paymentRequirements.asset` field will be `'lovelace'` by default (Zod schema default from Plan 01) or a `policyId.assetNameHex` string for token payments.

No other changes needed in verify.ts -- the verification pipeline (verifyPayment -> VERIFICATION_CHECKS) automatically picks up the new checks from Plan 02.

**2. Update `src/routes/settle.ts` -- add asset and getMinUtxoLovelace to VerifyContext:**

Same pattern as verify.ts. In the VerifyContext assembly block (around line 33-46), add:

```typescript
const ctx: VerifyContext = {
  // ... existing fields ...

  // NEW: Asset identifier from PaymentRequirements
  asset: paymentRequirements.asset,

  // NEW: Min UTXO callback from ChainProvider
  getMinUtxoLovelace: (numAssets: number) => fastify.chainProvider.getMinUtxoLovelace(numAssets),

  // ... existing fields continue ...
};
```

Settlement re-verification calls verifyPayment() with this context, so the new token checks (checkTokenSupported, checkAmount token branch, checkMinUtxo) are automatically applied. No changes to settle-payment.ts itself -- it is asset-agnostic by design.

**3. Update `src/verify/index.ts` -- add new check exports:**

Add `checkTokenSupported` and `checkMinUtxo` to the existing checks export:

```typescript
export {
  checkCborValid,
  checkScheme,
  checkNetwork,
  checkTokenSupported,  // NEW (Phase 5)
  checkRecipient,
  checkAmount,
  checkMinUtxo,         // NEW (Phase 5)
  checkWitness,
  checkTtl,
  checkFee,
  VERIFICATION_CHECKS,
} from './checks.js';
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- compiles with no errors. Run `pnpm build` -- succeeds. Run `pnpm test` -- all existing tests pass. Verify that both route handlers now include `asset` and `getMinUtxoLovelace` in their VerifyContext assembly.
  </verify>
  <done>Both /verify and /settle route handlers thread paymentRequirements.asset and chainProvider.getMinUtxoLovelace into VerifyContext. Settlement re-verify automatically picks up token checks. No changes needed to settle-payment.ts (asset-agnostic). Barrel exports updated with new check functions.</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for token payment flows</name>
  <files>tests/integration/verify-route.test.ts, tests/integration/settle-route.test.ts</files>
  <action>
**1. Update `tests/integration/verify-route.test.ts` -- add token payment tests:**

The existing integration tests mock `verifyPayment` at the module level (line 42-44). Token verification logic lives inside `verifyPayment`, so integration tests verify that the route correctly threads the `asset` field into the mock call. Add tests within the existing `describe('POST /verify Route')` block.

Update the `createTestVerifyRequest` helper to accept an optional `asset` parameter:

```typescript
function createTestVerifyRequest(overrides?: Record<string, unknown>) {
  return {
    paymentPayload: {
      x402Version: 2,
      scheme: 'exact',
      network: 'cardano:preview',
      payload: {
        transaction: 'SGVsbG8gV29ybGQ=',
        payer: 'addr_test1qz2fxv2umyhttkxyxp8x0dlpdt3k6cwng5pxj3jhsydzer3jcu5d8ps7zex2k2xt3uqxgjqnnj83ws8lhrn648jjxtwq2ytjqp',
      },
    },
    paymentRequirements: {
      scheme: 'exact',
      network: 'cardano:preview',
      asset: 'lovelace',
      maxAmountRequired: '2000000',
      payTo: 'addr_test1qz2fxv2umyhttkxyxp8x0dlpdt3k6cwng5pxj3jhsydzer3jcu5d8ps7zex2k2xt3uqxgjqnnj83ws8lhrn648jjxtwq2ytjqp',
      maxTimeoutSeconds: 300,
      ...overrides,
    },
  };
}
```

NOTE: Check the existing helper -- it may already structure the request differently. Match the existing pattern but ensure `asset` is included in `paymentRequirements`.

**New test cases (5 tests):**

1. **Token payment -- asset field threaded to verifyPayment:**
   Send a request with `asset: 'c48cbb3d5e57ed56e276bc45f99ab39abe94e6cd7ac39fb402da47ad.0014df105553444d'` (USDM). Mock verifyPayment to return `{ isValid: true, payer: 'addr...' }`. Assert that verifyPayment was called with a context where `ctx.asset` matches the USDM asset string.

   ```typescript
   it('threads token asset into verifyPayment context', async () => {
     const usdmAsset = 'c48cbb3d5e57ed56e276bc45f99ab39abe94e6cd7ac39fb402da47ad.0014df105553444d';
     mockVerifyPayment.mockResolvedValueOnce({ isValid: true });
     const response = await app.inject({
       method: 'POST',
       url: '/verify',
       payload: createTestVerifyRequest({ asset: usdmAsset }),
     });
     expect(response.statusCode).toBe(200);
     const ctx = mockVerifyPayment.mock.calls[0][0];
     expect(ctx.asset).toBe(usdmAsset);
   });
   ```

2. **ADA default -- asset defaults to 'lovelace' when omitted:**
   Send a request without `asset` in paymentRequirements. Assert that verifyPayment receives `ctx.asset === 'lovelace'` (Zod schema default).

3. **getMinUtxoLovelace callback is provided:**
   Assert that the context passed to verifyPayment has a `getMinUtxoLovelace` property that is a function.

4. **Token verification failure surfaced:**
   Mock verifyPayment to return `{ isValid: false, invalidReason: 'unsupported_token', invalidMessage: 'Token is not supported...' }`. Assert response body matches.

5. **ADA backward compatibility:**
   Existing test "valid verification request returns isValid:true" still passes (no regression). This is an existing test -- just verify it is NOT broken.

**2. Update `tests/integration/settle-route.test.ts` -- add token payment tests:**

The existing settle tests mock `settlePayment` at the module level. Add tests verifying asset threading.

Update the `createTestSettleRequest` helper (or equivalent) to include `asset`:

**New test cases (3 tests):**

1. **Token asset threaded to settlePayment context:**
   Send a settle request with `asset: 'c48cbb3d5e57ed56e276bc45f99ab39abe94e6cd7ac39fb402da47ad.0014df105553444d'`. Mock settlePayment to return `{ success: true, transaction: 'abc123...', network: 'cardano:preview' }`. Assert settlePayment was called and the ctx argument has `ctx.asset` matching the USDM asset string.

2. **ADA default for settle:**
   Send settle request without `asset`. Assert settlePayment ctx has `asset === 'lovelace'`.

3. **getMinUtxoLovelace provided in settle context:**
   Assert that the ctx passed to settlePayment has `getMinUtxoLovelace` as a function.

Follow the existing mock patterns in settle-route.test.ts. The settle tests mock `settlePayment` (not `verifyPayment`) so focus on verifying the ctx shape passed to the mock.
  </action>
  <verify>
Run `pnpm test -- tests/integration/verify-route.test.ts` -- all tests pass (existing + new). Run `pnpm test -- tests/integration/settle-route.test.ts` -- all tests pass (existing + new). Run `pnpm build && pnpm test` -- full suite passes. Verify total test count increased by ~8 from the pre-phase baseline of 206.
  </verify>
  <done>Integration tests confirm end-to-end token payment flow through routes. /verify threads asset and getMinUtxoLovelace into VerifyContext correctly. /settle threads the same fields for re-verification. ADA backward compatibility confirmed (omitting asset defaults to 'lovelace'). All existing tests pass with no regressions.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `pnpm lint` passes
- `pnpm test` passes (all tests including new integration tests)
- `npx tsc --noEmit` passes
- /verify route assembles VerifyContext with `asset: paymentRequirements.asset`
- /verify route provides `getMinUtxoLovelace` callback from chainProvider
- /settle route assembles VerifyContext with same asset and getMinUtxoLovelace fields
- Omitting `asset` from paymentRequirements defaults to 'lovelace' (Zod schema)
- Token asset string is passed through to verifyPayment unchanged
- settle-payment.ts has ZERO changes (asset-agnostic by design)
- All 206+ tests pass (no regressions)
</verification>

<success_criteria>
Stablecoin payment support is complete end-to-end. Route handlers thread token identity into the verification pipeline. Settlement re-verification automatically applies token checks. ADA payments continue to work exactly as before (backward compatible). The facilitator now accepts USDM, DJED, and iUSD payments in addition to ADA, with proper validation of token support, token amounts, and min UTXO requirements.
</success_criteria>

<output>
After completion, create `.planning/phases/05-stablecoins/05-03-SUMMARY.md`
</output>
