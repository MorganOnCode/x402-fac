---
phase: 05-stablecoins
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/verify/token-registry.ts
  - src/verify/types.ts
  - src/verify/verify-payment.ts
  - src/verify/index.ts
  - tests/unit/verify/token-registry.test.ts
autonomous: true

must_haves:
  truths:
    - "Token registry maps unit strings to TokenEntry for USDM, DJED, and iUSD"
    - "ADA payments use asset='lovelace' and are always accepted (no registry lookup)"
    - "Unknown/unsupported token units are identifiable via registry lookup returning undefined"
    - "VerifyContext carries optional asset identifier and optional getMinUtxoLovelace callback (optional for incremental rollout)"
    - "PaymentRequirementsSchema accepts optional asset field defaulting to 'lovelace'"
    - "New failure reasons (unsupported_token, min_utxo_insufficient) have human-readable messages"
  artifacts:
    - path: "src/verify/token-registry.ts"
      provides: "SUPPORTED_TOKENS map, TokenEntry interface, LOVELACE_UNIT constant, helper functions"
      exports: ["SUPPORTED_TOKENS", "TokenEntry", "LOVELACE_UNIT", "isTokenPayment", "getToken", "assetToUnit"]
    - path: "src/verify/types.ts"
      provides: "Extended VerifyContext with optional asset? and getMinUtxoLovelace? fields"
      contains: "asset?: string"
    - path: "src/verify/verify-payment.ts"
      provides: "Updated FAILURE_MESSAGES with unsupported_token and min_utxo_insufficient"
      contains: "unsupported_token"
    - path: "tests/unit/verify/token-registry.test.ts"
      provides: "Unit tests for token registry lookup, ADA passthrough, unknown rejection"
  key_links:
    - from: "src/verify/token-registry.ts"
      to: "src/verify/checks.ts"
      via: "Token registry consumed by check functions (Plan 05-02)"
      pattern: "SUPPORTED_TOKENS|LOVELACE_UNIT|assetToUnit"
    - from: "src/verify/types.ts"
      to: "src/routes/verify.ts"
      via: "Route handler assembles VerifyContext with new asset field (Plan 05-03)"
      pattern: "asset:|getMinUtxoLovelace"
---

<objective>
Create the token registry, extend VerifyContext with stablecoin fields, and add failure messages for new check types.

Purpose: Establish the type and data foundation that the new verification checks (Plan 02) and route updates (Plan 03) depend on. The token registry is the security gate -- only hardcoded tokens are accepted. No new dependencies needed.

Output: `src/verify/token-registry.ts`, updated `src/verify/types.ts`, updated `src/verify/verify-payment.ts`, updated `src/verify/index.ts`, `tests/unit/verify/token-registry.test.ts`
</objective>

<execution_context>
@/Users/morgan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stablecoins/05-CONTEXT.md
@.planning/phases/05-stablecoins/05-RESEARCH.md
@src/verify/types.ts
@src/verify/verify-payment.ts
@src/verify/index.ts
@src/chain/provider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create token registry with hardcoded stablecoin entries</name>
  <files>src/verify/token-registry.ts, tests/unit/verify/token-registry.test.ts</files>
  <action>
Create `src/verify/token-registry.ts` with hardcoded token definitions. This file is the security gate -- every supported token must be explicitly listed here, requiring a code change and review to add new tokens.

**Interface:**

```typescript
/** A supported Cardano native token. */
export interface TokenEntry {
  /** Policy ID (28-byte hex, 56 chars) */
  policyId: string;
  /** Asset name in hex */
  assetNameHex: string;
  /** Human-readable ticker (for logging only, not for matching) */
  ticker: string;
}
```

**Constants:**

```typescript
/** Special constant for ADA payments (not a token). */
export const LOVELACE_UNIT = 'lovelace';
```

**Registry Map:**

Create `SUPPORTED_TOKENS` as a `ReadonlyMap<string, TokenEntry>` keyed by the concatenated unit string (policyId + assetNameHex). Include all three tokens per locked decision:

- USDM: policyId `c48cbb3d5e57ed56e276bc45f99ab39abe94e6cd7ac39fb402da47ad`, assetNameHex `0014df105553444d`, ticker `USDM`
- DJED: policyId `8db269c3ec630e06ae29f74bc39edd1f87c819f1056206e879a1cd61`, assetNameHex `446a65644d6963726f555344`, ticker `DJED`
- iUSD: policyId `f66d78b4a3cb3d37afa0ec36461e51ecbde00f26c8f0a68f94b69880`, assetNameHex `69555344`, ticker `iUSD`

**Helper functions:**

```typescript
/** Check if an asset identifier represents a token payment (not ADA). */
export function isTokenPayment(asset: string): boolean {
  return asset !== LOVELACE_UNIT;
}

/** Look up a token by its unit string (policyId + assetNameHex concatenated). */
export function getToken(unit: string): TokenEntry | undefined {
  return SUPPORTED_TOKENS.get(unit);
}

/**
 * Convert API asset format (policyId.assetNameHex) to internal unit (concatenated).
 * Returns "lovelace" unchanged.
 */
export function assetToUnit(asset: string): string {
  if (asset === LOVELACE_UNIT) return asset;
  return asset.replace('.', '');
}
```

**Tests** (`tests/unit/verify/token-registry.test.ts`):

Follow the existing test pattern from `tests/unit/verify/checks.test.ts` (import from `../../../src/...`, use `describe`/`it`/`expect`).

Test cases:
1. `SUPPORTED_TOKENS` has exactly 3 entries
2. `getToken` returns USDM entry for USDM unit string
3. `getToken` returns DJED entry for DJED unit string
4. `getToken` returns iUSD entry for iUSD unit string
5. `getToken` returns undefined for unknown unit (e.g., `'ff'.repeat(28) + 'aabb'`)
6. `isTokenPayment` returns false for `'lovelace'`
7. `isTokenPayment` returns true for a token unit string
8. `assetToUnit` returns `'lovelace'` unchanged
9. `assetToUnit` strips dot from `policyId.assetNameHex` format (e.g., `'aabb.ccdd'` becomes `'aabbccdd'`)
10. `LOVELACE_UNIT` equals `'lovelace'`
11. Each token entry has a 56-char policyId (validate all three)
12. Each token entry has a non-empty assetNameHex (validate all three)
  </action>
  <verify>
Run `npx tsc --noEmit` -- compiles with no errors. Run `pnpm test -- tests/unit/verify/token-registry.test.ts` -- all tests pass. Verify `SUPPORTED_TOKENS.size === 3`. Verify `getToken` returns undefined for unknown units.
  </verify>
  <done>Token registry created with USDM, DJED, iUSD entries keyed by concatenated unit strings. Helper functions (isTokenPayment, getToken, assetToUnit) exported. 12 unit tests pass covering lookup, rejection, and format conversion.</done>
</task>

<task type="auto">
  <name>Task 2: Extend VerifyContext, PaymentRequirementsSchema, and failure messages</name>
  <files>src/verify/types.ts, src/verify/verify-payment.ts, src/verify/index.ts</files>
  <action>
**1. Update `src/verify/types.ts` -- extend VerifyContext:**

Add two new **optional** fields to the `VerifyContext` interface:

```typescript
/** Asset identifier: "lovelace" for ADA, or "policyId.assetNameHex" for tokens.
 *  Optional for backward compatibility -- checks default to 'lovelace' when absent. */
asset?: string;

/** Calculate min UTXO lovelace for an output carrying the given number of distinct assets.
 *  For ADA-only outputs, numAssets=0. For token outputs, numAssets=1+.
 *  Optional -- checkMinUtxo skips when absent (existing routes won't have it until Plan 03). */
getMinUtxoLovelace?: (numAssets: number) => Promise<bigint>;
```

These go after `feeMax` and before the pipeline state section. Both fields are **optional** so that existing route handlers (verify.ts and settle.ts) continue to compile and work correctly between Plan 01 and Plan 03. The new check functions (Plan 02) default `asset` to `'lovelace'` when not provided, and `checkMinUtxo` skips when `getMinUtxoLovelace` is absent.

IMPORTANT: Making these optional prevents type errors in verify.ts and settle.ts between Plan 01 and Plan 03. Plan 03 will always provide both fields, making them effectively required at runtime.

The `PaymentRequirementsSchema` already has an `asset: z.string()` field (line 63 of types.ts), which is good. However, it currently has no default. Add `.default('lovelace')` to make it backward compatible for ADA-only clients:

```typescript
/** Asset identifier ("lovelace" for ADA, "policyId.assetNameHex" for tokens) */
asset: z.string().default('lovelace'),
```

NOTE: The existing `asset: z.string()` on line 63 must be changed to `asset: z.string().default('lovelace')`. This ensures backward compatibility -- existing clients that do not send `asset` will default to ADA payments.

**2. Update `src/verify/verify-payment.ts` -- add failure messages:**

Add two new entries to the `FAILURE_MESSAGES` record:

```typescript
unsupported_token: 'Token is not supported by this facilitator',
min_utxo_insufficient: 'Output does not contain enough ADA for minimum UTXO requirement',
```

**3. Update `src/verify/index.ts` -- add barrel exports:**

Add exports for the new token-registry module:

```typescript
// Token registry (Phase 5)
export { SUPPORTED_TOKENS, LOVELACE_UNIT, isTokenPayment, getToken, assetToUnit } from './token-registry.js';
export type { TokenEntry } from './token-registry.js';
```

Also add the `checkTokenSupported` and `checkMinUtxo` export placeholders as comments for Plan 02:

```typescript
// New check functions will be exported after Plan 05-02
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- compiles with no errors. Run `pnpm build` -- succeeds. Run `pnpm test` -- all existing 206 tests pass (no regressions). Verify that `VerifyContext` now includes optional `asset?` and `getMinUtxoLovelace?` fields. Verify `PaymentRequirementsSchema` defaults `asset` to `'lovelace'`. Verify `FAILURE_MESSAGES` includes `unsupported_token` and `min_utxo_insufficient`. Crucially, verify that verify.ts and settle.ts still compile WITHOUT providing the new fields (they are optional).
  </verify>
  <done>VerifyContext extended with optional asset? (string) and getMinUtxoLovelace? callback. PaymentRequirementsSchema.asset defaults to 'lovelace' for backward compatibility. Two new failure messages added. Token registry exports wired through barrel. All existing tests pass with no regressions -- existing route handlers do not need to provide the new fields yet (they are optional). Plan 03 will always provide both fields.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `pnpm lint` passes
- `pnpm test` passes (existing 206 tests + new token-registry tests)
- `npx tsc --noEmit` passes
- Token registry has exactly 3 entries (USDM, DJED, iUSD) with correct mainnet policy IDs
- `assetToUnit('lovelace')` returns `'lovelace'`
- `assetToUnit('aabb.ccdd')` returns `'aabbccdd'`
- `getToken('unknown')` returns undefined
- VerifyContext now requires `asset` and `getMinUtxoLovelace` fields
- PaymentRequirementsSchema.asset defaults to 'lovelace'
- FAILURE_MESSAGES has entries for 'unsupported_token' and 'min_utxo_insufficient'
- Existing test helpers updated with new VerifyContext fields
</verification>

<success_criteria>
Token registry and type extensions are in place. SUPPORTED_TOKENS maps three stablecoin unit strings to their metadata. VerifyContext carries asset identification and min UTXO callback. PaymentRequirementsSchema is backward compatible. Foundation ready for Plan 02 (new checks) and Plan 03 (route updates).
</success_criteria>

<output>
After completion, create `.planning/phases/05-stablecoins/05-01-SUMMARY.md`
</output>
