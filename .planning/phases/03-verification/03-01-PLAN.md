---
phase: 03-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/verify/types.ts
  - src/verify/errors.ts
  - src/verify/index.ts
  - src/config/schema.ts
  - src/chain/config.ts
  - src/errors/index.ts
autonomous: true

must_haves:
  truths:
    - "Verification domain types define the x402 wire format for Cardano"
    - "Verification errors are distinct from chain errors and follow VERIFY_* naming"
    - "Config schema accepts graceBufferSeconds and maxTimeoutSeconds with defaults"
  artifacts:
    - path: "src/verify/types.ts"
      provides: "VerifyRequest, VerifyResponse, CardanoPayload, PaymentRequirements, CheckResult, VerifyContext Zod schemas and TS types"
      exports: ["VerifyRequestSchema", "VerifyResponseSchema", "CardanoPayloadSchema", "PaymentRequirementsSchema"]
    - path: "src/verify/errors.ts"
      provides: "VERIFY_* domain errors"
      exports: ["VerifyInvalidFormatError", "VerifyInternalError"]
    - path: "src/verify/index.ts"
      provides: "Barrel exports for verify module"
    - path: "src/config/schema.ts"
      provides: "Extended config with verification section"
      contains: "verification"
  key_links:
    - from: "src/verify/types.ts"
      to: "x402 V2 spec"
      via: "VerifyRequest/VerifyResponse shapes matching spec"
      pattern: "isValid.*boolean"
    - from: "src/errors/index.ts"
      to: "src/verify/errors.ts"
      via: "re-export of VERIFY_* errors"
      pattern: "VerifyInvalidFormatError"
---

<objective>
Define all verification domain types, Zod schemas, domain errors, and config schema extension for Phase 3.

Purpose: Establish the type foundation that all subsequent verification plans depend on. Types define the x402 wire format compliance, Zod schemas provide request validation, errors define the VERIFY_* domain, and config extends to include verification settings (grace buffer, max timeout).

Output: `src/verify/types.ts`, `src/verify/errors.ts`, `src/verify/index.ts`, updated `src/config/schema.ts` and `src/chain/config.ts`, updated `src/errors/index.ts`
</objective>

<execution_context>
@/Users/morgan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-verification/03-CONTEXT.md
@.planning/phases/03-verification/03-RESEARCH.md
@src/chain/types.ts
@src/chain/errors.ts
@src/chain/config.ts
@src/config/schema.ts
@src/errors/index.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verification types and Zod schemas</name>
  <files>src/verify/types.ts</files>
  <action>
Create `src/verify/types.ts` with all verification domain types and Zod schemas.

**x402 Wire Format Types (with Zod schemas for validation):**

1. `PaymentRequirementsSchema` - what the server requires:
   - `x402Version: z.literal(2)` (pinned V2)
   - `scheme: z.string()` (e.g., "exact")
   - `network: z.string()` (CAIP-2 chain ID, e.g., "cardano:preview")
   - `maxAmountRequired: z.string()` (lovelace as string for JSON compat)
   - `resource: z.string().optional()` (resource URL)
   - `description: z.string().optional()`
   - `mimeType: z.string().optional()`
   - `payTo: z.string()` (facilitator bech32 address)
   - `maxTimeoutSeconds: z.number().int().positive()` (validity window)
   - `extra: z.record(z.unknown()).optional()` (Cardano extension bag)
   - Use `.passthrough()` on the object schema for lenient parsing (per research recommendation)

2. `CardanoPayloadSchema` - what the client sends:
   - `signature: z.string().min(1)` (COSE_Sign1 hex from CIP-30 signData)
   - `key: z.string().min(1)` (COSE_Key hex from CIP-30 signData)
   - `nonce: z.string().min(1)` (facilitator-issued nonce)

3. `PaymentPayloadSchema` - the full payment payload wrapper:
   - `x402Version: z.literal(2)`
   - `accepted: PaymentRequirementsSchema` (the requirements being accepted)
   - `payload: CardanoPayloadSchema` (the Cardano-specific signed data)
   - Use `.passthrough()`

4. `VerifyRequestSchema` - POST /verify body:
   - `x402Version: z.literal(2)`
   - `paymentPayload: PaymentPayloadSchema`
   - `paymentRequirements: PaymentRequirementsSchema`
   - Use `.passthrough()`

5. `VerifyResponseSchema` - verify response (for documentation, not validation):
   - `isValid: z.boolean()`
   - `payer: z.string().optional()` (bech32 address)
   - `invalidReason: z.string().optional()` (snake_case)
   - `extra: z.record(z.unknown()).optional()`

**Internal Types (plain TypeScript, no Zod):**

6. `CheckResult` interface:
   - `check: string` (check name)
   - `passed: boolean`
   - `reason?: string` (snake_case invalidReason)

7. `VerifyCheck` type: `(ctx: VerifyContext) => Promise<CheckResult>`

8. `VerifyContext` interface (assembled by orchestrator from parsed request):
   - `scheme: string`
   - `network: string`
   - `payTo: string`
   - `maxAmountRequired: bigint` (converted from string)
   - `maxTimeoutSeconds: number`
   - `signature: string` (COSE_Sign1 hex)
   - `key: string` (COSE_Key hex)
   - `nonce: string`
   - `payerAddress?: string` (extracted from COSE_Sign1 if available)
   - `requestedAt: number` (Date.now() when request arrived)
   - `extra?: Record<string, unknown>`

9. `CAIP2_CHAIN_IDS` constant mapping CardanoNetwork to CAIP-2 strings:
   ```typescript
   export const CAIP2_CHAIN_IDS: Record<CardanoNetwork, string> = {
     Preview: 'cardano:preview',
     Preprod: 'cardano:preprod',
     Mainnet: 'cardano:mainnet',
   } as const;
   ```
   Import `CardanoNetwork` from `../chain/types.js`.

Export all schemas (named `...Schema`), inferred types (named without Schema suffix), all interfaces, the VerifyCheck type, and the CAIP2_CHAIN_IDS constant.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with no errors. The types file should export at least 9 named exports (5 schemas, CAIP2_CHAIN_IDS, CheckResult, VerifyCheck, VerifyContext).
  </verify>
  <done>All x402 wire format types have Zod schemas with `.passthrough()`. Internal types (CheckResult, VerifyContext, VerifyCheck) are plain interfaces/types. CAIP2_CHAIN_IDS maps networks to chain IDs.</done>
</task>

<task type="auto">
  <name>Task 2: Create verification errors, barrel exports, and extend config</name>
  <files>src/verify/errors.ts, src/verify/index.ts, src/config/schema.ts, src/chain/config.ts, src/errors/index.ts</files>
  <action>
**1. Create `src/verify/errors.ts`:**

Using `@fastify/error` (same pattern as `src/chain/errors.ts`):
- `VerifyInvalidFormatError` - code `VERIFY_INVALID_FORMAT`, message `'Invalid verification request format: %s'`, status 200 (NOT 400 -- per CONTEXT.md "always HTTP 200")
- `VerifyInternalError` - code `VERIFY_INTERNAL_ERROR`, message `'Verification internal error: %s'`, status 500

NOTE: Most verification failures are NOT errors -- they return `{ isValid: false }` as HTTP 200. These errors are only for truly exceptional cases (e.g., verifyData() throws an unexpected exception).

**2. Create `src/verify/index.ts`:**

Barrel exports for the verify module:
- All types and schemas from `./types.js` (use `export type { ... }` for type-only exports per ESM decision)
- All errors from `./errors.js`
- (Later plans will add nonce-store, checks, verify-payment exports here)

**3. Extend `src/chain/config.ts`:**

Add a `verification` section to `ChainConfigSchema`:
```typescript
verification: z.object({
  /** Grace buffer in seconds for validity window (default 30s per CONTEXT.md) */
  graceBufferSeconds: z.number().int().min(0).max(120).default(30),
  /** Default max timeout in seconds (default 300s = 5 min per CONTEXT.md) */
  maxTimeoutSeconds: z.number().int().min(60).max(3600).default(300),
  /** Nonce TTL in seconds (should match maxTimeoutSeconds for auto-expiry) */
  nonceTtlSeconds: z.number().int().min(60).max(3600).default(300),
}).default(() => ({
  graceBufferSeconds: 30,
  maxTimeoutSeconds: 300,
  nonceTtlSeconds: 300,
})),
```

Add this inside the existing `ChainConfigSchema` z.object (after the `redis` section, before `.superRefine`).

**4. Update `src/errors/index.ts`:**

Add re-export of verify errors (same pattern as chain errors re-export):
```typescript
// Verification errors (VERIFY_*) - re-exported from verify domain
export {
  VerifyInvalidFormatError,
  VerifyInternalError,
} from '../verify/errors.js';
```

**5. Run `pnpm build` to verify everything compiles.**

IMPORTANT: The `verification` config section goes inside `ChainConfigSchema` because verification settings are chain-specific (grace buffer relates to Cardano block times). This keeps all chain-related config together.
  </action>
  <verify>
Run `pnpm build && pnpm lint`. Both should pass. Verify `src/verify/index.ts` re-exports types and errors. Verify `src/errors/index.ts` re-exports VERIFY_* errors. Verify `src/chain/config.ts` includes the verification section with defaults.
  </verify>
  <done>VERIFY_* errors created with @fastify/error. Barrel exports working. Config schema extended with verification.graceBufferSeconds (default 30), verification.maxTimeoutSeconds (default 300), verification.nonceTtlSeconds (default 300). All existing tests still pass.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `pnpm lint` passes
- `pnpm test` passes (existing tests unbroken by config extension -- defaults maintain backward compat)
- `npx tsc --noEmit` passes
- Types file exports Zod schemas for VerifyRequest, CardanoPayload, PaymentRequirements
- CAIP2_CHAIN_IDS maps Preview/Preprod/Mainnet to cardano:* strings
- Config accepts verification section with grace buffer + timeout defaults
</verification>

<success_criteria>
All verification domain types, Zod schemas, errors, barrel exports, and config schema extensions exist and compile. No existing tests broken. Foundation ready for Plans 02-05.
</success_criteria>

<output>
After completion, create `.planning/phases/03-verification/03-01-SUMMARY.md`
</output>
